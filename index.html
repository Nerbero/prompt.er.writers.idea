<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generatore di Prompt Narrativi Strutturati</title>
    <!-- Font Awesome per le icone -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <!-- SortableJS per il drag-and-drop -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>

    <style>
        /* Reset e box-sizing */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            transition: background-color 0.3s, color 0.3s; /* Transizione fluida per il tema */
        }

        /* Variabili CSS per i colori (modalità chiara) */
        :root {
            --primary: #4361ee; /* Blu profondo */
            --secondary: #3f37c9; /* Blu più scuro */
            --success: #4cc9f0; /* Azzurro brillante */
            --light: #f8f9fa; /* Sfondo molto chiaro */
            --dark: #212529; /* Testo scuro */
            --text: #333; /* Colore testo principale */
            --bg: #f0f2f5; /* Sfondo generale */
            --card-bg: #ffffff; /* Sfondo delle card/sezioni */
            --border: #e0e0e0; /* Colore bordo generico */
            --shadow: 0 6px 20px rgba(0, 0, 0, 0.1); /* Ombra standard */
            --protocol-bg: #f8f9fa; /* Sfondo sezione protocollo */
            --protocol-border: #6c757d; /* Bordo sezione protocollo */
            --chapter-bg: #f8fcf9; /* Sfondo sezione capitolo */
            --chapter-border: #d1e7dd; /* Bordo sezione capitolo */
            --danger: #dc3545; /* Rosso per rimozione */
            --danger-hover: #c82333;
            --warning: #ffc107; /* Giallo per reset */
            --warning-text: #333;
            --input-border-focus: #80bdff;
            --input-shadow-focus: rgba(0, 123, 255, 0.25);
            --output-bg: #e9ecef;
            --output-border: #dcdcdc;
            --output-text: #495057;
            --copy-msg-bg: #28a745;
            --info-btn: #17a2b8; /* Colore per il nuovo pulsante */
            --info-btn-hover: #138496;
            --explanation-bg: #e6f7ff; /* Sfondo per la sezione spiegazioni */
            --explanation-border: #91d5ff; /* Bordo per la sezione spiegazioni */
            --explanation-text: #084298; /* Colore testo per la sezione spiegazioni */
            --music-btn-color: #ff5722; /* Arancione per il pulsante musica */
            --music-btn-hover: #e64a19;
        }

        /* Modalità scura */
        .dark-mode {
            --primary: #4895ef;
            --secondary: #4361ee;
            --success: #4cc9f0;
            --light: #121212;
            --dark: #e0e0e0;
            --text: #e0e0e0;
            --bg: #121212;
            --card-bg: #1e1e1e;
            --border: #333;
            --shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
            --protocol-bg: #2d2d2d;
            --protocol-border: #4cc9f0;
            --chapter-bg: #222;
            --chapter-border: #3a3a3a;
            --danger: #9f3a47;
            --danger-hover: #7b2a33;
            --warning: #d9a400;
            --warning-text: #eee;
            --input-border-focus: #4cc9f0;
            --input-shadow-focus: rgba(76, 201, 240, 0.25);
            --output-bg: #2a2a2a;
            --output-border: #3a3a3a;
            --output-text: #c0c0c0;
            --copy-msg-bg: #218838;
            --info-btn: #20c997; /* Colore per il nuovo pulsante in dark mode */
            --info-btn-hover: #18a280;
            --explanation-bg: #1a2a3a; /* Sfondo per la sezione spiegazioni in dark mode */
            --explanation-border: #4cc9f0; /* Bordo per la sezione spiegazioni in dark mode */
            --explanation-text: #a0d9ff; /* Colore testo per la sezione spiegazioni in dark mode */
            --music-btn-color: #ff9800; /* Arancione più chiaro per dark mode */
            --music-btn-hover: #fb8c00;
        }

        /* Stili del corpo principale */
        body {
            font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            padding: 20px;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            box-sizing: border-box;
        }

        /* Contenitore principale dell'app */
        .container {
            max-width: 1000px; /* Aumentato per accogliere più contenuto */
            width: 100%;
            margin: 0 auto;
            padding: 30px;
            background-color: var(--card-bg);
            border-radius: 12px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            box-sizing: border-box;
        }

        /* Header con titolo e toggle tema */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 30px;
            flex-wrap: wrap; /* Per la responsività */
            gap: 20px;
        }

        .header-content {
            flex: 1;
            min-width: 280px; /* Per evitare che si schiacci troppo */
        }

        h1 {
            font-size: 2.2rem;
            color: var(--primary);
            margin-bottom: 10px;
            font-weight: 800; /* Extra bold */
            display: flex;
            align-items: center;
            gap: 12px;
        }

        h1 i {
            font-size: 1.1em;
            color: var(--success); /* Icona con colore diverso */
        }

        .subtitle {
            font-size: 1.1rem;
            color: var(--text);
            opacity: 0.9;
            max-width: 700px;
            line-height: 1.6;
        }

        /* Pulsanti toggle (tema e musica) */
        .toggle-buttons {
            display: flex;
            gap: 15px; /* Spazio tra i pulsanti */
            flex-shrink: 0;
        }

        .toggle-btn {
            background: var(--primary);
            color: white;
            border: none;
            width: 50px; /* Dimensione aumentata */
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem; /* Icona più grande */
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            flex-shrink: 0; /* Non si restringe */
        }

        .toggle-btn:hover {
            background: var(--secondary);
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

        .music-toggle {
            background: var(--music-btn-color);
        }

        .music-toggle:hover {
            background: var(--music-btn-hover);
        }


        /* Sezione Protocollo Narrativo */
        .protocol-section {
            background-color: var(--protocol-bg);
            border-left: 4px solid var(--protocol-border);
            padding: 25px;
            margin: 30px 0;
            border-radius: 0 12px 12px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .protocol-section h3 {
            color: var(--primary);
            margin-bottom: 20px;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 2px solid var(--border);
            padding-bottom: 10px;
        }

        .protocol-section h3 i {
            font-size: 1.2em;
            color: var(--success);
        }

        .protocol-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-top: 15px;
        }

        .protocol-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            border: 1px solid var(--border);
            transition: transform 0.3s, box-shadow 0.3s;
            display: flex;
            flex-direction: column;
        }

        .protocol-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }

        .protocol-card h4 {
            margin-top: 0;
            color: var(--primary);
            font-size: 1.1rem;
            border-bottom: 2px solid var(--border);
            padding-bottom: 12px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .protocol-card h4 i {
            color: var(--success);
        }

        .protocol-card ul {
            font-size: 0.95rem;
            padding-left: 22px;
            margin-bottom: 0;
            line-height: 1.7;
            list-style: disc;
            flex-grow: 1;
        }

        .protocol-card li {
            margin-bottom: 8px;
        }

        .protocol-card strong {
            color: var(--primary);
        }

        /* Stili per i campi di input delle transizioni */
        .transition-input-group {
            margin-bottom: 15px; /* Spazio aumentato */
        }
        .transition-input-group label {
            font-size: 0.95em; /* Leggermente più grande */
            font-weight: 600; /* Più in evidenza */
            margin-bottom: 8px; /* Spazio aumentato */
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .transition-input-group input[type="text"] {
            padding: 10px; /* Padding aumentato */
            font-size: 0.95em; /* Leggermente più grande */
            border-radius: 8px; /* Angoli più arrotondati */
            width: 100%;
            box-sizing: border-box;
            background: var(--card-bg);
            color: var(--text);
            border: 1px solid var(--border);
        }
        .transition-input-group input[type="text"]:focus {
            border-color: var(--primary);
            outline: 0;
            box-shadow: 0 0 0 3px var(--input-shadow-focus);
        }

        /* Sezione Info Box (Suggerimenti) */
        .info-box {
            background: rgba(67, 97, 238, 0.08); /* Colore primario con opacità */
            border-left: 4px solid var(--primary);
            padding: 20px;
            border-radius: 0 8px 8px 0;
            margin: 30px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            color: var(--text);
        }

        .info-title {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--primary);
            margin-bottom: 15px;
            font-weight: 700;
            font-size: 1.1rem;
        }

        .info-title i {
            font-size: 1.2em;
        }

        .info-content {
            line-height: 1.7;
            font-size: 0.95rem;
        }

        .info-content p {
            margin-bottom: 5px;
        }
        .info-content p:last-child {
            margin-bottom: 0;
        }

        /* Sezione Selezione Genere */
        .genre-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); /* Più flessibile e compatto */
            gap: 15px;
            margin: 25px 0;
        }

        .genre-card {
            background: var(--card-bg);
            border: 2px solid var(--border);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .genre-card:hover {
            border-color: var(--primary);
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.08);
        }

        /* Stile migliorato per il genere attivo */
        .genre-card.active {
            border-color: var(--primary);
            background: rgba(67, 97, 238, 0.15); /* Sfondo più scuro */
            box-shadow: 0 8px 25px rgba(0,0,0,0.2); /* Ombra più pronunciata */
            transform: translateY(-3px); /* Leggero sollevamento */
        }


        .genre-icon {
            font-size: 2.8rem; /* Icona più grande */
            color: var(--primary);
            margin-bottom: 15px;
        }

        .genre-title {
            font-weight: 700; /* Più spesso */
            margin-bottom: 5px;
            color: var(--text);
            font-size: 1.05rem;
        }

        .genre-desc {
            font-size: 0.85rem; /* Più piccolo */
            color: #6c757d;
        }

        /* Stili per i gruppi di form generali */
        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--text);
            font-size: 1.05rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        input[type="text"],
        input[type="number"],
        select,
        textarea {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid var(--border);
            border-radius: 10px;
            background: var(--card-bg);
            color: var(--text);
            font-size: 1rem;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus,
        textarea:focus {
            border-color: var(--primary);
            outline: 0;
            box-shadow: 0 0 0 3px var(--input-shadow-focus);
        }

        textarea {
            resize: vertical;
            min-height: 120px;
        }

        /* Stili per le sezioni dei capitoli */
        .chapter-section {
            border: 1px solid var(--chapter-border);
            padding: 25px;
            margin-bottom: 25px;
            border-radius: 12px;
            background-color: var(--chapter-bg);
            position: relative;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            cursor: grab; /* Indica che l'elemento è trascinabile */
        }

        .chapter-section.sortable-chosen {
            background-color: rgba(67, 97, 238, 0.2); /* Sfondo leggero quando trascinato */
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            transform: scale(1.01);
        }

        .chapter-section.sortable-ghost {
            opacity: 0.4;
            background-color: var(--primary);
            border: 2px dashed var(--primary);
        }

        .chapter-section h3 {
            color: var(--primary); /* Verde per i titoli dei capitoli */
            margin-top: 0;
            margin-bottom: 20px;
            font-size: 1.6rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
            /* Aggiungi padding-right per fare spazio al pulsante */
            padding-right: 120px; /* Spazio per il pulsante */
        }

        .chapter-section h3 i {
            font-size: 1.2em;
            color: var(--success);
        }

        /* Info per il numero del capitolo dinamico */
        .chapter-number-info {
            font-size: 0.7em;
            font-weight: normal;
            color: var(--text);
            opacity: 0.7;
            margin-left: 10px;
        }

        /* Stili per i pulsanti */
        .btn {
            padding: 14px 25px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .btn i {
            font-size: 1.1em;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--secondary);
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
        }

        .btn-success {
            background-color: var(--success);
            color: white;
        }

        .btn-success:hover {
            background-color: #3ab0d9;
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
        }

        .btn-warning {
            background-color: var(--warning);
            color: var(--warning-text);
        }

        .btn-warning:hover {
            background-color: #e0a800;
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
            /* Modifiche per posizionamento */
            position: absolute;
            top: 20px; /* Spostato più in basso */
            right: 20px; /* Spostato più a destra */
            padding: 8px 15px;
            font-size: 0.85em;
            z-index: 10;
            box-shadow: none;
        }

        .btn-danger:hover {
            background-color: var(--danger-hover);
            transform: none;
            box-shadow: none;
        }

        .btn-info { /* Nuovo stile per il pulsante "Aderente alla Bozza" */
            background-color: var(--info-btn);
            color: white;
        }

        .btn-info:hover {
            background-color: var(--info-btn-hover);
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
        }

        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 40px 0;
        }

        .action-buttons .btn {
            flex: 1; /* Distribuisce equamente i bottoni */
            min-width: 150px; /* Evita che diventino troppo piccoli */
        }

        /* Info per il salvataggio della bozza */
        .save-draft-info {
            font-size: 0.9rem;
            color: var(--text);
            opacity: 0.8;
            margin-top: 10px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
            text-align: center;
        }
        .save-draft-info i {
            color: var(--primary);
        }

        .add-chapter-btn {
            background-color: var(--primary); /* Usa il colore primario */
            color: white;
            margin-top: 25px;
            width: auto;
            display: block;
            margin-left: auto;
            margin-right: auto;
            padding: 12px 25px;
            font-size: 1.05em;
        }

        .add-chapter-btn:hover {
            background-color: var(--secondary);
        }

        .generate-btn {
            background-color: var(--success); /* Usa il colore success */
            color: white;
            width: 100%;
            margin-top: 40px;
            font-size: 1.2rem;
            padding: 18px 30px;
            box-shadow: 0 6px 15px rgba(0,0,0,0.15);
        }
        .generate-btn:hover {
            background-color: #3ab0d9;
        }

        /* Output del prompt */
        #promptOutput {
            background-color: var(--output-bg);
            padding: 25px;
            border-radius: 10px;
            white-space: pre-wrap;
            word-wrap: break-word;
            min-height: 250px; /* Altezza minima aumentata */
            border: 1px solid var(--output-border);
            margin-top: 30px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.95em;
            color: var(--output-text);
            position: relative;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.05); /* Ombra interna */
        }

        .output-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 10px;
        }

        .output-actions .btn {
            background-color: #6c757d;
            color: white;
            padding: 10px 18px;
            font-size: 0.95em;
            box-shadow: none;
        }

        .output-actions .btn:hover {
            background-color: #5a6268;
            transform: none;
            box-shadow: none;
        }

        /* Messaggi di notifica */
        .notification-message {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--copy-msg-bg);
            color: white;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 1rem;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease-out, visibility 0.5s ease-out;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            white-space: nowrap;
        }

        .notification-message.show {
            opacity: 1;
            visibility: visible;
        }

        hr {
            border: 0;
            height: 1px;
            background-image: linear-gradient(to right, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0));
            margin: 40px 0;
        }

        /* Layout per input di lunghezza/caratteri/atmosfera/dialoghi */
        .length-atm-input-group {
            display: flex;
            flex-wrap: wrap; /* Permette di andare a capo su schermi piccoli */
            gap: 15px;
            margin-top: 15px;
        }

        .length-atm-input-group > div {
            flex: 1;
            min-width: 120px; /* Larghezza minima per gli input */
        }
        .length-atm-input-group label {
            font-size: 0.9em;
            font-weight: normal;
            margin-bottom: 5px;
            color: var(--text);
            display: block; /* Assicura che la label sia su una riga separata */
        }
        .length-atm-input-group input[type="text"],
        .length-atm-input[type="number"] {
            padding: 8px;
            font-size: 0.9em;
            border-radius: 5px;
            min-height: 40px;
        }
        /* Stile per la textarea di evoluzione personaggi/ambientazione */
        .evolution-textarea {
            margin-top: 15px; /* Spazio sopra la textarea */
        }
        .evolution-textarea label {
            font-size: 0.95em;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text);
        }
        .evolution-textarea textarea {
            min-height: 80px; /* Altezza minima per le textarea di evoluzione */
            font-size: 0.9em;
            padding: 10px;
        }

        /* Sezione Spiegazioni Funzionalità */
        .explanation-section {
            background-color: var(--explanation-bg);
            border-left: 4px solid var(--explanation-border);
            padding: 25px;
            margin: 40px 0;
            border-radius: 0 12px 12px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            color: var(--explanation-text);
        }

        .explanation-section h3 {
            color: var(--primary);
            margin-bottom: 20px;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 2px solid var(--explanation-border);
            padding-bottom: 10px;
        }

        .explanation-section h3 i {
            font-size: 1.2em;
            color: var(--explanation-border);
        }

        .explanation-section p {
            margin-bottom: 15px;
            line-height: 1.6;
            font-size: 0.95rem;
        }

        .explanation-section strong {
            color: var(--primary);
        }

        /* Stili per il player musicale fisso */
        .music-player-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 320px; /* Larghezza fissa */
            height: 120px; /* Altezza fissa per un player compatto */
            background-color: var(--card-bg);
            border-radius: 12px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            overflow: hidden; /* Nasconde scrollbar interne dell'iframe */
            z-index: 999; /* Assicura che sia sopra gli altri elementi */
            display: none; /* Inizialmente nascosto */
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
        }

        .music-player-container.show {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        .music-player-container iframe {
            width: 100%;
            height: 100%;
            border: none;
        }


        /* Media Queries per responsività */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            h1 {
                font-size: 1.8rem;
                flex-direction: column;
                text-align: center;
                gap: 5px;
            }
            h1 i {
                margin-bottom: 5px;
            }
            .subtitle {
                font-size: 1.1rem;
            }
            header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            .toggle-buttons {
                align-self: flex-end;
            }
            .protocol-grid, .genre-selector {
                grid-template-columns: 1fr;
            }
            .action-buttons {
                flex-direction: column;
            }
            .btn {
                width: 100%;
            }
            .chapter-section h3 {
                font-size: 1.1rem; /* Ridotto ulteriormente per schermi piccoli */
                padding-right: 10px;
            }
            .btn-danger {
                top: 15px;
                right: 15px;
            }
            .length-atm-input-group {
                flex-direction: column;
                gap: 10px;
            }
            .music-player-container {
                width: 90%;
                height: 100px;
                left: 5%;
                right: auto;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            .container {
                padding: 15px;
            }
            h1 {
                font-size: 1.5rem;
            }
            .subtitle {
                font-size: 0.9rem;
            }
            .protocol-section, .info-box, .chapter-section, .explanation-section {
                padding: 15px;
            }
            .protocol-section h3, .info-title, .explanation-section h3 {
                font-size: 1.2rem;
            }
            .protocol-card, .genre-card {
                padding: 15px;
            }
            .genre-icon {
                font-size: 2rem;
            }
            .genre-title {
                font-size: 0.95rem;
            }
            .generate-btn {
                font-size: 1rem;
                padding: 15px 20px;
            }
            #promptOutput {
                padding: 15px;
                font-size: 0.85em;
            }
            .save-draft-info {
                font-size: 0.8rem;
            }
        }

        /* Stili specifici per il Gioco Narrativo */
        #gameApp {
            display: flex;
            flex-direction: column; /* Stack elements vertically */
            height: 100vh; /* Occupy full viewport height */
            margin: 0;
            padding: 0;
            background: var(--bg); /* Use theme background */
            color: var(--text); /* Use theme text color */
        }

        #game-header-banner {
            width: 100%;
            padding: 15px 20px; /* Smaller padding for banner feel */
            background-color: var(--card-bg); /* Use card background for header */
            border-bottom: 1px solid var(--border);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            flex-shrink: 0; /* Don't shrink */
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        #game-header-banner .header-content {
            flex: 1;
            min-width: 200px;
        }

        #game-header-banner h1 {
            font-size: 1.8rem; /* Smaller title for banner */
            margin-bottom: 5px;
            color: var(--primary);
        }

        #game-header-banner .subtitle {
            font-size: 0.9rem; /* Smaller subtitle */
            color: var(--text);
            opacity: 0.8;
        }

        #game-header-banner .toggle-buttons {
            gap: 10px;
        }

        #game-header-banner .toggle-btn {
            width: 40px;
            height: 40px;
            font-size: 1.2rem;
        }

        #game-main-content {
            display: flex;
            flex: 1; /* Take remaining space */
            width: 100%;
            overflow: hidden; /* Prevent internal scrollbars */
        }

        #gameApp #text-panel {
            width: 50%; /* Still 50% of the main content area */
            padding: 1.5rem 2rem;
            box-sizing: border-box;
            background: var(--card-bg); /* Use theme card background */
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            opacity: 1;
            transition: opacity 0.5s ease, background-image 1s ease-in-out;
            overflow-y: auto; /* Allow scrolling for text content */
            min-width: 300px; /* Maintain minimum width */
            background-size: cover;
            background-position: center;
            color: var(--text); /* Use theme text color for default */
            position: relative;
        }

        /* Ensure text color is always readable on image backgrounds */
        #gameApp #chapter-title,
        #gameApp #chapter-text {
            color: var(--text); /* Set to theme text color by default */
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.6); /* Add a subtle shadow for readability */
        }
        /* If chapter.darkText is true, make text light */
        #gameApp #text-panel.dark-text-override #chapter-title,
        #gameApp #text-panel.dark-text-override #chapter-text {
            color: #ffffff; /* Use white for dark backgrounds */
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }

        #gameApp #map-panel {
            width: 50%; /* Still 50% of the main content area */
            position: relative;
            background: var(--bg); /* Use theme background */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 1;
            transition: opacity 0.5s ease;
            overflow: hidden;
            min-width: 300px; /* Maintain minimum width */
        }

        #gameApp #map-panel.fade-out {
            opacity: 0;
        }

        #gameApp #map-container {
            position: relative;
            flex: 1;
            width: 90%;
            max-width: 600px;
            background-image: url('https://placehold.co/600x600/a0a0a0/ffffff?text=Fantasy+Map+Placeholder'); /* Immagine di sfondo predefinita */
            background-size: cover;
            background-position: center;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(42, 93, 143, 0.3);
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: grab;
        }

        #gameApp #map {
            position: relative;
            width: 100%;
            height: 100%;
            user-select: none;
            flex-shrink: 0;
            transform-origin: center center;
            transition: transform 0.1s ease-out;
        }

        #gameApp #map-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            pointer-events: none;
        }

        #gameApp .node {
            position: absolute;
            width: 60px;
            height: 60px;
            background-color: #4a7dbb;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 8px rgba(74, 125, 187, 0.5);
            transition: background-color 0.3s ease, box-shadow 0.3s ease, transform 0.3s ease;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #fff;
            font-weight: bold;
            user-select: none;
            text-align: center;
            padding: 0.3rem;
            line-height: 1.2;
            transform: translate(-50%, -50%);
            z-index: 2;
        }

        #gameApp .node.current {
            background-color: #f06e6e;
            box-shadow: 0 0 20px #f06e6e;
            animation: pulse 1.5s infinite alternate;
        }

        @keyframes pulse {
            from {
                transform: translate(-50%, -50%) scale(1);
            }
            to {
                transform: translate(-50%, -50%) scale(1.1);
            }
        }

        #gameApp #node-description {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.9);
            padding: 0.75rem 1rem;
            border-radius: 8px;
            width: 90%;
            font-size: 1rem;
            color: #333;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 10;
            text-align: center;
        }

        #gameApp #node-description.visible {
            opacity: 1;
        }

        #gameApp #zoom-controls {
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }

        #gameApp #zoom-controls button {
            padding: 8px 15px;
            background-color: #2a5d8f;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.3s ease;
        }

        #gameApp #zoom-controls button:hover {
            background-color: #1f4363;
        }

        #gameApp #bottom-panel-sections {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 1rem;
        }

        #gameApp #timeline-wrapper {
            background: #dbe9fa;
            border-radius: 8px;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.1);
            padding: 0.5rem 1rem;
        }

        #gameApp #timeline-wrapper h3 {
            margin-top: 0;
            margin-bottom: 0.5rem;
            color: #2a5d8f;
        }

        #gameApp #timeline {
            overflow-x: auto;
            white-space: nowrap;
            display: flex;
            align-items: center;
            padding-bottom: 0.5rem;
        }

        #gameApp .timeline-node {
            display: inline-block;
            padding: 0.3rem 0.6rem;
            margin-right: 0.5rem;
            background: #4a7dbb;
            color: white;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.9rem;
            user-select: none;
            transition: background-color 0.3s ease, transform 0.2s ease;
            flex-shrink: 0;
        }

        #gameApp .timeline-node:hover {
            background-color: #1f4363;
            transform: translateY(-2px);
        }

        #gameApp .timeline-node.current {
            background-color: #f06e6e;
            font-weight: 700;
        }

        #gameApp #diary {
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 1rem;
        }

        #gameApp #diary label {
            display: block;
            margin-bottom: 0.5rem;
            color: #2a5d8f;
        }

        #gameApp #diary textarea {
            width: 100%;
            height: 90px;
            resize: vertical;
            font-family: inherit;
            font-size: 1rem;
            padding: 0.5rem;
            border: 1px solid #999;
            border-radius: 4px;
            box-sizing: border-box;
        }

        #gameApp #diary button {
            margin-top: 0.5rem;
            padding: 0.5rem 1rem;
            background: #2a5d8f;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s ease;
        }

        #gameApp #diary button:hover {
            background-color: #1f4363;
        }

        #gameApp #custom-alert {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #4CAF50;
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            font-size: 1.1rem;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            pointer-events: none;
        }

        #gameApp #music-controls {
            position: absolute;
            top: 1rem;
            right: 1rem;
            z-index: 100;
            background-color: rgba(42, 93, 143, 0.8);
            border-radius: 8px;
            padding: 0.5rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        #gameApp #music-toggle-btn {
            background: none;
            border: 1px solid #fff;
            color: #fff;
            padding: 0.4rem 0.8rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        #gameApp #music-toggle-btn:hover {
            background-color: #fff;
            color: #2a5d8f;
        }

        #gameApp #soundcloud-player {
            display: none;
        }

        #game-footer-banner {
            width: 100%;
            padding: 15px 20px;
            background-color: var(--card-bg);
            border-top: 1px solid var(--border);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            flex-shrink: 0; /* Don't shrink */
            display: flex;
            justify-content: center; /* Center the button */
            align-items: center;
        }

        #game-footer-banner .action-buttons {
            margin: 0; /* Remove default margin */
            width: 100%;
            justify-content: center;
        }

        #game-footer-banner .btn {
            flex: none; /* Don't auto-flex */
            width: auto;
            min-width: 180px; /* Give it a decent size */
        }

        @media (max-width: 768px) {
            #game-main-content {
                flex-direction: column; /* Stack text and map panels vertically on small screens */
            }
            #gameApp #text-panel, #gameApp #map-panel {
                width: 100%;
                height: 50vh; /* Each takes half of the remaining height */
                min-width: auto;
                border-right: none; /* Remove right border when stacked */
                border-bottom: 1px solid var(--border); /* Add bottom border */
            }
            #gameApp #map-panel {
                border-bottom: none; /* No bottom border for the last panel */
            }
            #gameApp #timeline {
                max-height: 80px;
                font-size: 0.9rem;
            }
            #gameApp #music-controls {
                top: 0.5rem;
                right: 0.5rem;
                padding: 0.4rem 0.8rem;
            }
        }

        @media (prefers-reduced-motion: reduce) {
            #gameApp * {
                animation: none !important;
                transition: none !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Contenuto del Generatore di Prompt -->
        <div id="generatorApp">
            <header>
                <div class="header-content">
                    <h1><i class="fas fa-book-open"></i> Generatore di Prompt Narrativi Strutturati</h1>
                    <p class="subtitle">Strumento avanzato per la creazione di archi narrativi con struttura a 3 atti, ottimizzato per modelli MLL.</p>
                </div>
                <div class="toggle-buttons">
                    <button class="toggle-btn music-toggle" id="musicToggle">
                        <i class="fas fa-music"></i>
                    </button>
                    <button class="toggle-btn theme-toggle" id="themeToggle">
                        <i class="fas fa-moon"></i>
                    </button>
                </div>
            </header>

            <!-- Sezione Protocollo Narrativo -->
            <div class="protocol-section">
                <h3><i class="fas fa-cogs"></i> Protocollo Narrativo α-9</h3>
                <div class="protocol-grid">
                    <div class="protocol-card">
                        <h4><i class="fas fa-layer-group"></i> Struttura Capitolo</h4>
                        <ul>
                            <li><strong>Radicamento (P1):</strong> 5.200 crr | Atmosf 65-70%</li>
                            <li><strong>Torsione (P2):</strong> 5.200 crr | Atmosf 45-50%</li>
                            <li><strong>Risonanza (P3):</strong> 5.600 crr | Atmosf 25-30%</li>
                        </ul>
                    </div>

                    <div class="protocol-card">
                        <h4><i class="fas fa-sliders-h"></i> Parametri Personalizzati</h4>
                        <div class="form-group">
                            <label for="lengthP1"><i class="fas fa-ruler"></i> Lunghezza P1 (crr):</label>
                            <input type="number" id="lengthP1" value="5200" min="100" title="Lunghezza desiderata in caratteri per la Fase 1 (Radicamento).">
                        </div>
                        <div class="form-group">
                            <label for="atmP1"><i class="fas fa-cloud"></i> Atmosfera P1 (%):</label>
                            <input type="number" id="atmP1" value="70" min="0" max="100" title="Percentuale di atmosfera/tensione per la Fase 1 (Radicamento).">
                        </div>
                        <div class="form-group">
                            <label for="symP1"><i class="fas fa-shapes"></i> Simboli P1:</label>
                            <input type="number" id="symP1" value="3" min="1" max="10" title="Numero di simboli o elementi ricorrenti da introdurre nella Fase 1 (Radicamento).">
                        </div>
                        <div class="form-group">
                            <label for="turnP1"><i class="fas fa-exchange-alt"></i> Svolte ogni (crr):</label>
                            <input type="number" id="turnP1" value="800" min="100" title="Frequenza dei punti di svolta narrativi nella Fase 1 (Radicamento), espressa in caratteri.">
                        </div>
                    </div>

                    <div class="protocol-card">
                        <h4><i class="fas fa-arrows-alt-h"></i> Direttive Transizioni</h4>
                        <div class="transition-input-group">
                            <label for="transitionP1P2">P1→P2 (Conflitto):</label>
                            <input type="text" id="transitionP1P2" placeholder="Es. Conflitto fisico/tangibile" title="Descrivi il tipo di transizione o evento che porta dalla Fase 1 alla Fase 2.">
                        </div>
                        <div class="transition-input-group">
                            <label for="transitionP2P3">P2→P3 (Sviluppo):</label>
                            <input type="text" id="transitionP2P3" placeholder="Es. Sviluppo emotivo/psicologico" title="Descrivi il tipo di transizione o evento che porta dalla Fase 2 alla Fase 3.">
                        </div>
                        <div class="transition-input-group">
                            <label for="transitionP3Next">P3→Successivo (Fusione):</label>
                            <input type="text" id="transitionP3Next" placeholder="Es. Fusione simbolica/metafisica" title="Descrivi il tipo di transizione o evento che porta dalla Fase 3 alla conclusione o al capitolo successivo.">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Info Box Suggerimenti -->
            <div class="info-box">
                <div class="info-title">
                    <i class="fas fa-lightbulb"></i> Suggerimenti per un buon prompt
                </div>
                <div class="info-content">
                    <p>• Sii specifico ma lascia spazio alla creatività dell'AI</p>
                    <p>• Definisci chiaramente i personaggi e l'ambientazione</p>
                    <p>• Usa simboli coerenti con la tematica della storia</p>
                    <p>• Specifica il tono e lo stile narrativo desiderati</p>
                    <p>• Inserisci dettagli sensoriali per un'esperienza immersiva</p>
                </div>
            </div>

            <!-- Sezione Selezione Genere -->
            <div class="form-group">
                <label><i class="fas fa-tags"></i> Seleziona il genere/i generi:</label>
                <div class="genre-selector" id="genreSelector">
                    <div class="genre-card" data-genre="Thriller psicologico">
                        <div class="genre-icon"><i class="fas fa-brain"></i></div>
                        <div class="genre-title">Thriller psicologico</div>
                        <div class="genre-desc">Tensione mentale e suspense</div>
                    </div>
                    <div class="genre-card" data-genre="Fantascienza speculativa">
                        <div class="genre-icon"><i class="fas fa-rocket"></i></div>
                        <div class="genre-title">Fantascienza speculativa</div>
                        <div class="genre-desc">Futuri alternativi e tecnologia</div>
                    </div>
                    <div class="genre-card" data-genre="Distopia postindustriale">
                        <div class="genre-icon"><i class="fas fa-city"></i></div>
                        <div class="genre-title">Distopia postindustriale</div>
                        <div class="genre-desc">Società collassate e ribellione</div>
                    </div>
                    <div class="genre-card" data-genre="Romanzo introspettivo">
                        <div class="genre-icon"><i class="fas fa-user-injured"></i></div>
                        <div class="genre-title">Romanzo introspettivo</div>
                        <div class="genre-desc">Analisi psicologica e crescita</div>
                    </div>
                    <div class="genre-card" data-genre="Weird/Fabulismo">
                        <div class="genre-icon"><i class="fas fa-dragon"></i></div>
                        <div class="genre-title">Weird/Fabulismo</div>
                        <div class="genre-desc">Realtà distorte e simbolismo</div>
                    </div>
                    <!-- Nuovi generi aggiunti -->
                    <div class="genre-card" data-genre="Horror contemporaneo">
                        <div class="genre-icon"><i class="fas fa-ghost"></i></div>
                        <div class="genre-title">Horror contemporaneo</div>
                        <div class="genre-desc">Paura psicologica e minacce moderne. Stile alla Stephen King, Shirley Jackson.</div>
                    </div>
                    <div class="genre-card" data-genre="Narrativa classica">
                        <div class="genre-icon"><i class="fas fa-feather-alt"></i></div>
                        <div class="genre-title">Narrativa classica</div>
                        <div class="genre-desc">Storie senza tempo, focus su personaggi e temi universali. Stile alla Jane Austen, Charles Dickens.</div>
                    </div>
                    <div class="genre-card" data-genre="Giallo forense">
                        <div class="genre-icon"><i class="fas fa-search"></i></div>
                        <div class="genre-title">Giallo forense</div>
                        <div class="genre-desc">Indagini scientifiche e risoluzione di crimini.</div>
                    </div>
                </div>
            </div>

            <!-- Campi generali della storia -->
            <div class="form-group">
                <label for="titoloStoria"><i class="fas fa-heading"></i> Titolo della Storia (opzionale):</label>
                <input type="text" id="titoloStoria" placeholder="Es. L&#39;ombra del Drago">
            </div>

            <div class="form-group">
                <label for="tonoStile"><i class="fas fa-palette"></i> Tono e Stile:</label>
                <textarea id="tonoStile" placeholder="Es. Cupo e atmosferico, leggero e umoristico, epico e avventuroso. Ispirato a Tolkien."></textarea>
            </div>

            <div class="form-group">
                <label for="personaggiPrincipali"><i class="fas fa-users"></i> Personaggi Principali (descrizione sommaria):</label>
                <textarea id="personaggiPrincipali" placeholder="Es. Elara (giovane maga, coraggiosa ma ingenua), Kael (guerriero solitario, esperto di spade)."></textarea>
            </div>

            <div class="form-group">
                <label for="ambientazioneGenerale"><i class="fas fa-globe-americas"></i> Ambientazione Generale:</label>
                <textarea id="ambientazioneGenerale" placeholder="Es. Un regno medievale devastato dalla guerra, una stazione spaziale isolata, una città futuristica."></textarea>
            </div>

            <hr>

            <h2><i class="fas fa-map-marked-alt"></i> Trama Capitolo per Capitolo</h2>
            <div id="chaptersContainer">
                <!-- Il primo capitolo è già presente per default, verrà aggiornato/sostituito da JS -->
            </div>
            <button type="button" class="btn btn-primary add-chapter-btn" id="addChapterBtn">
                <i class="fas fa-plus-circle"></i> Aggiungi Capitolo
            </button>

            <div class="action-buttons">
                <button type="button" class="btn btn-secondary" id="saveBtn" title="Salva i tuoi progressi nel browser per riprendermi in seguito.">
                    <i class="fas fa-save"></i> Salva Bozza
                </button>
                <button type="button" class="btn btn-secondary" id="exportJsonBtn" title="Esporta la bozza corrente come file JSON.">
                    <i class="fas fa-file-export"></i> Esporta Bozza (JSON)
                </button>
                <!-- Input file nascosto per l'importazione -->
                <input type="file" id="importJsonInput" accept=".json" style="display: none;">
                <button type="button" class="btn btn-secondary" id="importJsonBtn" title="Importa una bozza da un file JSON.">
                    <i class="fas fa-file-import"></i> Importa Bozza (JSON)
                </button>
                <button type="button" class="btn btn-warning" id="fillRandomBtn">
                    <i class="fas fa-dice"></i> Compila Tutto Casualmente
                </button>
                <button type="button" class="btn btn-danger" id="resetBtn">
                    <i class="fas fa-undo"></i> Reset Campi
                </button>
                <button type="button" class="btn btn-info" id="goToGameBtn">
                    <i class="fas fa-gamepad"></i> Gioco Narrativo
                </button>
            </div>
            <div class="save-draft-info">
                <i class="fas fa-info-circle"></i> Salva i tuoi progressi nel browser per riprendermi in seguito.
            </div>

            <button type="button" class="btn generate-btn" id="generatePromptBtn">
                <i class="fas fa-file-alt"></i> Genera Prompt Finale
            </button>

            <hr>

            <h2><i class="fas fa-file-alt"></i> Prompt Generato</h2>
            <div class="output-actions">
                <button type="button" class="btn btn-secondary" id="copyPromptBtn">
                    <i class="fas fa-copy"></i> Copia Prompt
                </button>
                <button type="button" class="btn btn-secondary" id="downloadPromptBtn">
                    <i class="fas fa-download"></i> Esporta in TXT
                </button>
            </div>
            <pre id="promptOutput"></pre>
        </div>

        <!-- Contenuto del Gioco Narrativo (inizialmente nascosto) -->
        <div id="gameApp" style="display: none;">
            <!-- Header del Gioco (nuovo banner superiore) -->
            <div id="game-header-banner">
                <div class="header-content">
                    <h1><i class="fas fa-gamepad"></i> Gioco Narrativo</h1>
                    <p class="subtitle">Benvenuto nel gioco narrativo! Qui potrai interagire con le tue storie.</p>
                </div>
                <div class="toggle-buttons">
                    <button class="toggle-btn music-toggle" id="musicToggleGame">
                        <i class="fas fa-music"></i>
                    </button>
                    <button class="toggle-btn theme-toggle" id="themeToggleGame">
                        <i class="fas fa-moon"></i>
                    </button>
                </div>
            </div>

            <!-- Contenuto principale del gioco (pannelli testo e mappa) -->
            <div id="game-main-content">
                <div id="text-panel">
                    <h1 id="chapter-title"></h1>
                    <p id="chapter-text"></p>

                    <div id="choices">
                        <!-- I pulsanti di scelta verranno inseriti dinamicamente qui -->
                    </div>

                    <div id="bottom-panel-sections">
                        <div id="timeline-wrapper">
                            <h3>Cronologia Scelte</h3>
                            <div id="timeline">
                                <!-- I nodi della timeline verranno inseriti dinamicamente qui -->
                            </div>
                        </div>

                        <div id="diary">
                            <label for="diary-note"><strong>Diario personale:</strong></label>
                            <textarea id="diary-note" placeholder="Scrivi qui le tue riflessioni, appunti o ricordi..."></textarea>
                            <button id="save-diary">Salva Nota</button>
                        </div>
                    </div>

                    <!-- Controlli musicali spostati all'interno del text-panel -->
                    <div id="music-controls">
                        <button id="music-toggle-btn">Avvia Musica</button>
                        <!-- SoundCloud player iframe, initially visible but then hidden by CSS -->
                        <iframe id="soundcloud-player" width="100%" height="100px" scrolling="no" frameborder="no" allow="autoplay" src="https://w.soundcloud.com/player/?url=https%3A//api.soundcloud.com/tracks/101306056&color=%23ff5500&auto_play=false&hide_related=false&show_comments=true&show_user=true&show_reposts=false&show_teaser=true&visual=false"></iframe>
                    </div>
                </div>

                <div id="map-panel">
                    <div id="map-container">
                        <canvas id="map-canvas"></canvas> <!-- Canvas per disegnare le linee -->
                        <div id="map">
                            <!-- I nodi della mappa verranno inseriti dinamicamente qui -->
                        </div>
                        <div id="node-description"></div>
                    </div>
                    <div id="zoom-controls">
                        <button id="reset-zoom-btn">Reset Zoom</button>
                    </div>
                </div>
            </div>

            <div id="custom-alert"></div> <!-- Elemento per l'alert personalizzato -->
            
            <!-- Footer del Gioco (nuovo banner inferiore) -->
            <div id="game-footer-banner">
                <div class="action-buttons" style="justify-content: center;">
                    <button type="button" class="btn btn-secondary" id="backToGeneratorBtn">
                        <i class="fas fa-arrow-left"></i> Torna al Generatore
                    </button>
                </div>
            </div>
        </div>

        <!-- Player musicale fisso in basso a destra -->
        <div id="musicPlayerContainer" class="music-player-container">
            <!-- L'iframe avrà il suo src impostato dinamicamente -->
            <iframe id="audioPlayerIframe" src="" scrolling="no" frameborder="0" allow="autoplay" title="SoundCloud Player"></iframe>
        </div>

        <!-- Sezione Spiegazioni Funzionalità A Piè Pagina -->
        <div class="explanation-section">
            <h3><i class="fas fa-info-circle"></i> Guida all'Esportazione e Funzionalità Aggiuntive</h3>
            <p>Qui trovi una spiegazione chiara delle diverse opzioni di esportazione e delle nuove funzionalità:</p>
            <p>
                •   <strong>Esporta Bozza (JSON):</strong> Questo pulsante ti permette di salvare una copia completa di <strong>tutti i dati che hai inserito nel generatore</strong> (titolo, personaggi, ambientazione, generi, tutti i dettagli dei capitoli e i parametri del protocollo). Il file scaricato sarà in formato `.json`. È utile per creare un <strong>backup del tuo lavoro</strong>, per spostare la bozza su un altro computer o browser, o per condividerla con qualcuno che voglia riutilizzare la tua configurazione nello stesso generatore.
            </p>
            <p>
                •   <strong>Esporta in TXT:</strong> Questo pulsante scarica un semplice file di testo (`.txt`) che contiene <strong>solo il prompt finale generato</strong>, ovvero il testo che appare nella sezione "Prompt Generato". Questo formato è ideale per copiare e incollare direttamente il prompt in un modello di linguaggio (come Gemini, ChatGPT, ecc.) o per archiviare il risultato testuale finale del tuo lavoro.
            </p>
            <p>
                •   <strong>Percentuale Dialoghi:</strong> Per ogni fase del capitolo (Inizio, Sviluppo, Fine), puoi ora specificare una percentuale approssimativa di dialoghi rispetto ai caratteri totali della sezione. Questo permette di controllare il bilanciamento tra narrazione descrittiva e interazioni tra personaggi nel prompt generato.
            </p>
            <p>
                •   <strong>Musica di Sottofondo (<i class="fas fa-music"></i>):</strong> Il nuovo pulsante con l'icona della nota musicale nella parte superiore destra ti permette di attivare o disattivare una musica di sottofondo atmosferica. Cliccando su di esso, un piccolo player musicale apparirà o scomparirà nell'angolo in basso a destra dello schermo, offrendo un'esperienza più immersiva durante la creazione del tuo prompt.
            </p>
            <p>
                In sintesi: usa <strong>JSON per salvare la tua bozza modificabile</strong>, e <strong>TXT per salvare il prompt finale da utilizzare</strong>. La <strong>Percentuale Dialoghi</strong> ti dà un controllo più fine sulla struttura del testo generato, mentre il pulsante <strong>Musica</strong> migliora l'atmosfera di lavoro.
            </p>
        </div>

    </div>

    <!-- Messaggio di notifica personalizzato -->
    <div id="notificationMessage" class="notification-message"></div>

    <script>
        let chapterCount = 0; // Inizializza il conteggio dei capitoli a 0
        let selectedGenres = []; // Variabile per tenere traccia dei generi selezionati (ARRAY)

        // Dark Mode Toggle per il generatore
        const themeToggle = document.getElementById('themeToggle');
        const themeIcon = themeToggle.querySelector('i');
        
        // Dark Mode Toggle per il gioco (nuovo)
        const themeToggleGame = document.getElementById('themeToggleGame');
        const themeIconGame = themeToggleGame.querySelector('i');

        // Music Toggle elements (main app)
        const musicToggle = document.getElementById('musicToggle');
        const musicToggleGame = document.getElementById('musicToggleGame');
        const musicPlayerContainer = document.getElementById('musicPlayerContainer');
        const audioPlayerIframe = document.getElementById('audioPlayerIframe'); // Get the iframe element
        // Updated music source to SoundCloud with autoplay enabled
        const audioSrc = "https://w.soundcloud.com/player/?url=https%3A//api.soundcloud.com/tracks/101306056&color=%23ff5500&auto_play=true&hide_related=false&show_comments=true&show_user=true&show_reposts=false&show_teaser=true&visual=true";

        // Controlla se c'è una preferenza salvata per il tema
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') {
            document.body.classList.add('dark-mode');
            themeIcon.className = 'fas fa-sun';
            themeIconGame.className = 'fas fa-sun'; // Aggiorna anche l'iconon del gioco
        }
        
        themeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            
            if (document.body.classList.contains('dark-mode')) {
                themeIcon.className = 'fas fa-sun';
                themeIconGame.className = 'fas fa-sun'; // Sincronizza l'icona
                localStorage.setItem('theme', 'dark');
            } else {
                themeIcon.className = 'fas fa-moon';
                themeIconGame.className = 'fas fa-moon'; // Sincronizza l'icona
                localStorage.setItem('theme', 'light');
            }
        });

        // Sincronizza il toggle del tema del gioco con quello principale
        themeToggleGame.addEventListener('click', () => {
            themeToggle.click(); // Simula il click sul toggle principale
        });

        // Controlla se c'è una preferenza salvata per la musica
        const savedMusicState = localStorage.getItem('musicState');
        if (savedMusicState === 'show') {
            musicPlayerContainer.classList.add('show');
            audioPlayerIframe.src = audioSrc; // Set src if it should be shown on load
        }

        // Toggle musica - MODIFICATA PER FERMARE LA MUSICA
        function toggleMusicPlayer() {
            if (musicPlayerContainer.classList.contains('show')) {
                // Se è mostrato, nascondilo e ferma la musica
                musicPlayerContainer.classList.remove('show');
                audioPlayerIframe.src = ''; // Imposta src vuoto per fermare la riproduzione
                localStorage.setItem('musicState', 'hidden');
                showNotification('Musica di sottofondo disattivata.', 'info');
            } else {
                // Se è nascosto, mostralo e avvia la musica
                musicPlayerContainer.classList.add('show');
                audioPlayerIframe.src = audioSrc; // Ripristina src per avviare la riproduzione
                localStorage.setItem('musicState', 'show');
                showNotification('Musica di sottofondo attivata.', 'info');
            }
        }

        musicToggle.addEventListener('click', toggleMusicPlayer);
        musicToggleGame.addEventListener('click', toggleMusicPlayer);


        // Selezione genere (modificato per selezione multipla)
        const genreCards = document.querySelectorAll('.genre-card');

        genreCards.forEach(card => {
            card.addEventListener('click', () => {
                const genre = card.dataset.genre;
                if (selectedGenres.includes(genre)) {
                    // Se già selezionato, deseleziona
                    selectedGenres = selectedGenres.filter(g => g !== genre);
                    card.classList.remove('active');
                    showNotification(`Genere deselezionato: ${genre}`);
                } else {
                    // Se non selezionato, seleziona
                    selectedGenres.push(genre);
                    card.classList.add('active');
                    showNotification(`Genere selezionato: ${genre}`);
                }
                // Aggiorna la notifica con tutti i generi selezionati
                if (selectedGenres.length > 0) {
                    showNotification(`Generi attivi: ${selectedGenres.join(', ')}`);
                } else {
                    showNotification('Nessun genere selezionato.');
                }
            });
        });

        // Funzione per mostrare notifiche personalizzate
        function showNotification(message, type = 'info') {
            const notificationElement = document.getElementById('notificationMessage');
            notificationElement.textContent = message;
            notificationElement.className = `notification-message show ${type}`; // Aggiungi il tipo per lo stile
            setTimeout(() => {
                notificationElement.classList.remove('show');
            }, 2000); // Il messaggio scompare dopo 2 secondi
        }

        /**
         * Aggiunge una nuova sezione di capitolo al contenitore.
         * @param {object} chapterData - Dati precompilati per il capitolo (opzionale).
         */
        function addChapter(chapterData = {}) {
            chapterCount++;
            const chaptersContainer = document.getElementById('chaptersContainer');
            const newChapterHtml = `
                <div class="chapter-section" id="chapter-${chapterCount}">
                    <button type="button" class="btn btn-danger remove-chapter-btn" data-chapter-id="${chapterCount}">
                        <i class="fas fa-trash-alt"></i> Rimuovi Capitolo
                    </button>
                    <h3><i class="fas fa-book-reader"></i> Capitolo ${chapterCount} <span class="chapter-number-info">(Trascina per riordinare)</span></h3>
                    <div class="form-group">
                        <label for="chapterTitle-${chapterCount}">Titolo del Capitolo (opzionale):</label>
                        <input type="text" id="chapterTitle-${chapterCount}" class="chapter-title-input" placeholder="Introduzione al Mondo" value="${chapterData.title || ''}">
                    </div>
                    <div class="form-group">
                        <label for="chapterContext-${chapterCount}">Contesto dal Capitolo Precedente (se applicabile):</label>
                        <textarea id="chapterContext-${chapterCount}" class="chapter-context-input" placeholder="Riassumi brevemente gli eventi cruciali o lo stato finale del capitolo precedente che devono essere considerati.">${chapterData.context || ''}</textarea>
                    </div>
                    <div class="form-group">
                        <label for="chapterStart-${chapterCount}">1. Inizio Capitolo (Setup/Hook):</label>
                        <textarea id="chapterStart-${chapterCount}" class="chapter-start-input" placeholder="Descrivi la scena iniziale, l'atmosfera, l'evento che dà il via al capitolo.">${chapterData.start || ''}</textarea>
                        <div class="length-atm-input-group">
                            <div>
                                <label for="chapterStartLength-${chapterCount}">Lunghezza (crr):</label>
                                <input type="number" id="chapterStartLength-${chapterCount}" class="chapter-start-length-input" value="${chapterData.startLength || '1000'}" min="100">
                            </div>
                            <div>
                                <label for="chapterStartAtm-${chapterCount}">Atmosfera (%):</label>
                                <input type="number" id="chapterStartAtm-${chapterCount}" class="chapter-start-atm-input" value="${chapterData.startAtm || '70'}" min="0" max="100">
                            </div>
                            <div>
                                <label for="chapterStartDialogues-${chapterCount}">Dialoghi (%):</label>
                                <input type="number" id="chapterStartDialogues-${chapterCount}" class="chapter-start-dialogues-input" value="${chapterData.startDialogues || '20'}" min="0" max="100">
                            </div>
                        </div>
                        <div class="form-group evolution-textarea">
                            <label for="chapterStartChars-${chapterCount}">Evoluzione Personaggi/Ambientazione (Inizio):</label>
                            <textarea id="chapterStartChars-${chapterCount}" class="chapter-start-chars-input" placeholder="Es. Il protagonista si sente disorientato, l'ambientazione rivela un dettaglio inquietante.">${chapterData.startChars || ''}</textarea>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="chapterMiddle-${chapterCount}">2. Sviluppo Centrale (Rising Action/Conflict):</label>
                        <textarea id="chapterMiddle-${chapterCount}" class="chapter-middle-input" placeholder="Descrivi gli eventi principali, lo sviluppo del conflitto, le interazioni chiave dei personaggi.">${chapterData.middle || ''}</textarea>
                        <div class="length-atm-input-group">
                            <div>
                                <label for="chapterMiddleLength-${chapterCount}">Lunghezza (crr):</label>
                                <input type="number" id="chapterMiddleLength-${chapterCount}" class="chapter-middle-length-input" value="${chapterData.middleLength || '2000'}" min="100">
                            </div>
                            <div>
                                <label for="chapterMiddleAtm-${chapterCount}">Atmosfera (%):</label>
                                <input type="number" id="chapterMiddleAtm-${chapterCount}" class="chapter-middle-atm-input" value="${chapterData.middleAtm || '50'}" min="0" max="100">
                            </div>
                            <div>
                                <label for="chapterMiddleDialogues-${chapterCount}">Dialoghi (%):</label>
                                <input type="number" id="chapterMiddleDialogues-${chapterCount}" class="chapter-middle-dialogues-input" value="${chapterData.middleDialogues || '40'}" min="0" max="100">
                            </div>
                        </div>
                        <div class="form-group evolution-textarea">
                            <label for="chapterMiddleChars-${chapterCount}">Evoluzione Personaggi/Ambientazione (Sviluppo):</label>
                            <textarea id="chapterMiddleChars-${chapterCount}" class="chapter-middle-chars-input" placeholder="Es. Il conflitto si intensifica, il personaggio affronta un dilemma morale."></textarea>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="chapterEnd-${chapterCount}">3. Fine Capitolo (Climax/Resolution/Cliffhanger):</label>
                        <textarea id="chapterEnd-${chapterCount}" class="chapter-end-input" placeholder="Descrivi come si conclude il capitolo: un mini-climax, una risoluzione parziale, o un cliffhanger per il capitolo successivo.">${chapterData.end || ''}</textarea>
                        <div class="length-atm-input-group">
                            <div>
                                <label for="chapterEndLength-${chapterCount}">Lunghezza (crr):</label>
                                <input type="number" id="chapterEndLength-${chapterCount}" class="chapter-end-length-input" value="${chapterData.endLength || '1500'}" min="100">
                            </div>
                            <div>
                                <label for="chapterEndAtm-${chapterCount}">Atmosfera (%):</label>
                                <input type="number" id="chapterEndAtm-${chapterCount}" class="chapter-end-atm-input" value="${chapterData.endAtm || '30'}" min="0" max="100">
                            </div>
                            <div>
                                <label for="chapterEndDialogues-${chapterCount}">Dialoghi (%):</label>
                                <input type="number" id="chapterEndDialogues-${chapterCount}" class="chapter-end-dialogues-input" value="${chapterData.endDialogues || '30'}" min="0" max="100">
                            </div>
                        </div>
                        <div class="form-group evolution-textarea">
                            <label for="chapterEndChars-${chapterCount}">Evoluzione Personaggi/Ambientazione (Fine):</label>
                            <textarea id="chapterEndChars-${chapterCount}" class="chapter-end-chars-input" placeholder="Es. Il personaggio prende una decisione cruciale, l'ambientazione si trasforma."></textarea>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="chapterNextContext-${chapterCount}">Contesto per il Capitolo Successivo:</label>
                        <textarea id="chapterNextContext-${chapterCount}" class="chapter-next-context-input" placeholder="Descrivi brevemente cosa accadrà nel capitolo successivo o quali elementi verranno introdotti/sviluppati, per garantire una transizione fluida.">${chapterData.nextContext || ''}</textarea>
                    </div>
                </div>
            `;
            chaptersContainer.insertAdjacentHTML('beforeend', newChapterHtml);

            // Add event listener for the new remove button
            chaptersContainer.querySelector(`[data-chapter-id="${chapterCount}"]`).addEventListener('click', (event) => {
                removeChapter(parseInt(event.target.dataset.chapterId));
            });
        }

        /**
         * Rimuove una sezione di capitolo specifica in base all'ID.
         * @param {number} id - L'ID numerico del capitolo da rimuovere.
         */
        function removeChapter(id) {
            const chapterToRemove = document.getElementById(`chapter-${id}`);
            if (chapterToRemove) {
                chapterToRemove.remove();
                updateChapterNumbers();
                showNotification(`Capitolo ${id} rimosso.`, 'info');
            }
        }

        /**
         * Aggiorna i numeri dei capitoli e gli ID degli elementi dopo una rimozione o riordinamento.
         */
        function updateChapterNumbers() {
            const chapterSections = document.querySelectorAll('.chapter-section');
            chapterSections.forEach((section, index) => {
                const newId = index + 1;
                section.id = `chapter-${newId}`;
                // Update chapter title and info span
                section.querySelector('h3').innerHTML = `<i class="fas fa-book-reader"></i> Capitolo ${newId} <span class="chapter-number-info">(Trascina per riordinare)</span>`;
                
                const removeBtn = section.querySelector('.remove-chapter-btn');
                if (removeBtn) {
                    removeBtn.dataset.chapterId = newId; // Update data attribute for removal
                }
                
                // Aggiorna gli ID e gli attributi 'for' delle label per gli input e textarea
                section.querySelectorAll('[id^="chapter"]').forEach(element => {
                    const oldIdParts = element.id.split('-');
                    const fieldName = oldIdParts[0]; // e.g., 'chapterTitle'
                    // Ensure the ID is correctly reconstructed for elements like 'chapterTitle-1'
                    if (oldIdParts.length === 2 && !isNaN(oldIdParts[1])) { // Checks for format 'fieldName-number'
                        const newElementId = `${fieldName}-${newId}`;
                        element.id = newElementId;
                        
                        const label = section.querySelector(`label[for="${oldIdParts.join('-')}"]`);
                        if (label) {
                            label.setAttribute('for', newElementId);
                        }
                    } else if (oldIdParts.length === 3 && !isNaN(oldIdParts[2])) { // Checks for format 'fieldName-subFieldName-number'
                        const subFieldName = oldIdParts[1];
                        const newElementId = `${fieldName}-${subFieldName}-${newId}`;
                        element.id = newElementId;

                        const label = section.querySelector(`label[for="${oldIdParts.join('-')}"]`);
                        if (label) {
                            label.setAttribute('for', newElementId);
                        }
                    }
                });
            });
            chapterCount = chapterSections.length;
        }

        /**
         * Genera la struttura protocollare per il prompt finale.
         */
        function generateProtocolSection() {
            const lengthP1 = document.getElementById('lengthP1').value.trim();
            const atmP1 = document.getElementById('atmP1').value.trim();
            const symP1 = document.getElementById('symP1').value.trim();
            const turnP1 = document.getElementById('turnP1').value.trim();
            const transitionP1P2 = document.getElementById('transitionP1P2').value.trim();
            const transitionP2P3 = document.getElementById('transitionP2P3').value.trim();
            const transitionP3Next = document.getElementById('transitionP3Next').value.trim();

            return `
## PROTOCOLLO APPLICATO

| Parametro          | Radicamento (P1) | Torsione (P2) | Risonanza (P3) |
|--------------------|------------------|---------------|----------------|
| Lunghezza          | ${lengthP1 || '5200'} crr (±5%)  | 5.200 crr (±5%) | 5.600 crr (±5%) |
| Atmosfera          | ${atmP1 || '70'}%           | 45-50%        | 25-30%         |
| Punti di svolta    | 1/${turnP1 || '800'} crr        | 1/700 crr     | 1/600 crr      |
| Simboli attivi     | ${symP1 || '3'} (introduzione) | 3 (trasform.) | 3 (fusione)    |

**Direttive Transizioni**:
- P1→P2: ${transitionP1P2 || 'Conflitto fisico/tangibile'}
- P2→P3: ${transitionP2P3 || 'Sviluppo emotivo/psicologico'}
- P3→Next: ${transitionP3Next || 'Fusione simbolica/metafisica'}

`;
        }

        /**
         * Genera il prompt completo basato sugli input dell'utente e lo visualizza.
         */
        function generatePrompt() {
            const titoloStoria = document.getElementById('titoloStoria').value.trim();
            const tonoStile = document.getElementById('tonoStile').value.trim();
            const personaggiPrincipali = document.getElementById('personaggiPrincipali').value.trim();
            const ambientazioneGenerale = document.getElementById('ambientazioneGenerale').value.trim();

            let promptText = `# Richiesta per Generazione Narrativa\n\n`;

            // Aggiungi la sezione protocollare all'inizio del prompt
            promptText += generateProtocolSection();

            if (titoloStoria) promptText += `**Titolo Proposto:** ${titoloStoria}\n`;
            // Modificato per gestire array di generi
            if (selectedGenres.length > 0) promptText += `**Generi Selezionati:** ${selectedGenres.join(', ')}\n`; 
            if (tonoStile) promptText += `**Tono e Stile:** ${tonoStile}\n`;
            if (personaggiPrincipali) promptText += `**Personaggi Principali:** ${personaggiPrincipali}\n`;
            if (ambientazioneGenerale) promptText += `**Ambientazione Generale:** ${ambientazioneGenerale}\n\n`;

            promptText += `--- \n\n## Trama Dettagliata per Capitoli\n\n`;

            let chapterNextContexts = []; // Per raccogliere i contesti successivi in ordine

            const chapterSections = document.querySelectorAll('.chapter-section');
            if (chapterSections.length === 0) {
                promptText += "Nessun capitolo specificato. Si prega di aggiungere almeno un capitolo.\n\n";
                showNotification('Nessun capitolo specificato. Aggiungi almeno un capitolo.', 'error');
            } else {
                chapterSections.forEach((section, index) => {
                    const chapterNum = index + 1;
                    const chapterTitle = section.querySelector('.chapter-title-input').value.trim();
                    const chapterContext = section.querySelector('.chapter-context-input').value.trim();
                    
                    const chapterStart = section.querySelector('.chapter-start-input').value.trim();
                    const chapterStartLength = section.querySelector('.chapter-start-length-input').value.trim();
                    const chapterStartAtm = section.querySelector('.chapter-start-atm-input').value.trim();
                    const chapterStartDialogues = section.querySelector('.chapter-start-dialogues-input').value.trim(); // NEW
                    const chapterStartChars = section.querySelector('.chapter-start-chars-input').value.trim();

                    const chapterMiddle = section.querySelector('.chapter-middle-input').value.trim();
                    const chapterMiddleLength = section.querySelector('.chapter-middle-length-input').value.trim();
                    const chapterMiddleAtm = section.querySelector('.chapter-middle-atm-input').value.trim();
                    const chapterMiddleDialogues = section.querySelector('.chapter-middle-dialogues-input').value.trim(); // NEW
                    const chapterMiddleChars = section.querySelector('.chapter-middle-chars-input').value.trim();

                    const chapterEnd = section.querySelector('.chapter-end-input').value.trim(); 
                    const chapterEndLength = section.querySelector('.chapter-end-length-input').value.trim();
                    const chapterEndAtm = section.querySelector('.chapter-end-atm-input').value.trim();
                    const chapterEndDialogues = section.querySelector('.chapter-end-dialogues-input').value.trim(); // NEW
                    const chapterEndChars = section.querySelector('.chapter-end-chars-input').value.trim();
                    
                    const chapterNextContext = section.querySelector('.chapter-next-context-input').value.trim();

                    promptText += `### Capitolo ${chapterNum}`;
                    if (chapterTitle) promptText += `: ${chapterTitle}`;
                    promptText += `\n`;
                    if (chapterContext) promptText += `- **Contesto dal Capitolo Precedente:** ${chapterContext}\n`;
                    promptText += `- **1. Inizio Capitolo (Radicamento/Setup):** ${chapterStart}\n`;
                    if (chapterStartLength) promptText += `  *(Lunghezza desiderata: ${chapterStartLength} crr)*\n`;
                    if (chapterStartAtm) promptText += `  *(Atmosfera desiderata: ${chapterStartAtm}%)*\n`;
                    if (chapterStartDialogues) promptText += `  *(Percentuale Dialoghi: ${chapterStartDialogues}%)*\n`; // NEW
                    if (chapterStartChars) promptText += `  *(Evoluzione Personaggi/Ambientazione: ${chapterStartChars})*\n`;
                    promptText += `\n`;

                    promptText += `- **2. Sviluppo Centrale (Torsione/Conflitto):** ${chapterMiddle}\n`;
                    if (chapterMiddleLength) promptText += `  *(Lunghezza desiderata: ${chapterMiddleLength} crr)*\n`;
                    if (chapterMiddleAtm) promptText += `  *(Atmosfera desiderata: ${chapterMiddleAtm}%)*\n`;
                    if (chapterMiddleDialogues) promptText += `  *(Percentuale Dialoghi: ${chapterMiddleDialogues}%)*\n`; // NEW
                    if (chapterMiddleChars) promptText += `  *(Evoluzione Personaggi/Ambientazione: ${chapterMiddleChars})*\n`;
                    promptText += `\n`;

                    promptText += `- **3. Fine Capitolo (Risonanza/Risoluzione/Cliffhanger):** ${chapterEnd}\n`;
                    if (chapterEndLength) promptText += `  *(Lunghezza desiderata: ${chapterEndLength} crr)*\n`;
                    if (chapterEndAtm) promptText += `  *(Atmosfera desiderata: ${chapterEndAtm}%)*\n`;
                    if (chapterEndDialogues) promptText += `  *(Percentuale Dialoghi: ${chapterEndDialogues}%)*\n`; // NEW
                    if (chapterEndChars) promptText += `  *(Evoluzione Personaggi/Ambientazione: ${chapterEndChars})*\n`;
                    promptText += `\n`;

                    if (chapterNextContext) {
                        chapterNextContexts.push(`- **Capitolo ${chapterNum} → Capitolo ${chapterNum + 1}:** ${chapterNextContext}`);
                    }
                });
            }

            if (chapterNextContexts.length > 0) {
                promptText += `## CONTESTO PER LE TRANSIZIONI TRA CAPITOLI\n\n`;
                promptText += chapterNextContexts.join('\n') + '\n\n';
            }

            promptText += `--- \n\n**Istruzioni Aggiuntive per il Modello:**\n`;
            promptText += `**STRATEGIA DI PROMPTING A IMBUTO (FUNNEL PROMPTING):**\n`;
            promptText += `Inizia la generazione della storia con una comprensione generale del tono, dello stile, dei personaggi e dell'ambientazione. Procedi poi a focalizzarti progressivamente sui dettagli specifici di ogni capitolo e delle sue fasi (Radicamento, Torsione, Risonanza), incorporando i contesti di transizione per garantire una narrazione fluida e coesa. Questo approccio ti permetterà di mantenere la coerenza complessiva mentre ti addentri nei particolari.\n\n`;
            promptText += `Genera la storia seguendo l'ordine dei capitoli specificato, suddividendo la narrazione in tre fasi principali che riflettono il "ritmo a imbuto":\n`;
            promptText += `1.  **FASE 1: RADICAMENTO (SETUP):** Concentrati sull'introduzione del mondo, dei personaggi e delle premesse iniziali. L'atmosfera dovrebbe essere coerente con le indicazioni fornite per l'inizio di ogni capitolo.\n`;
            promptText += `2.  **FASE 2: TORSIONE (CONFLITTO):** Sviluppa i conflitti principali, le sfide dei personaggi e l'escalation della trama. L'atmosfera dovrebbe riflettere la tensione crescente.\n`;
            promptText += `3.  **FASE 3: RISONANZA (RISOLUZIONE):** Porta la trama al suo climax, risolvi i conflitti e mostra la trasformazione dei personaggi. L'atmosfera dovrebbe culminare e poi risolversi.\n`;
            promptText += `**Contesto per la Transizione:** Utilizza i contesti specifici per le transizioni tra i capitoli per garantire una narrazione fluida e coerente tra le diverse sezioni e l'arco narrativo complessivo.\n`;
            promptText += `Assicurati che il tono e lo stile siano coerenti con quanto richiesto nella sezione iniziale.\n`;
            promptText += `Mantieni una narrazione fluida e coinvolgente, con transizioni logiche tra le sezioni e tra i capitoli.`;

            document.getElementById('promptOutput').textContent = promptText;
            showNotification('Prompt generato con successo!', 'success');
        }

        // Funzione per copiare il prompt negli appunti
        function copyPrompt() {
            const promptOutput = document.getElementById('promptOutput');
            const textToCopy = promptOutput.textContent;

            if (textToCopy.trim() === '') {
                showNotification('Genera un prompt prima di copiare!', 'error');
                return;
            }

            const textarea = document.createElement('textarea');
            textarea.value = textToCopy;
            textarea.style.position = 'fixed'; 
            textarea.style.opacity = 0;
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                showNotification('Prompt copiato!', 'success');
            } catch (err) {
                showNotification('Impossibile copiare il prompt.');
                console.error('Errore nella copia del testo: ', err);
            }
            document.body.removeChild(textarea);
        }

        // Funzione per scaricare il prompt come file TXT
        function downloadPrompt() {
            const promptContent = document.getElementById('promptOutput').textContent;
            if (promptContent.trim() === '') {
                showNotification('Genera un prompt prima di esportare!', 'error');
                return;
            }
            
            const blob = new Blob([promptContent], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.download = 'prompt-narrativo.txt';
            link.href = url;
            document.body.appendChild(link); // Necessario per Firefox
            link.click();
            document.body.removeChild(link); // Rimuovi l'elemento dopo il click
            URL.revokeObjectURL(url); // Libera la risorsa
            
            showNotification('Prompt esportato con successo!', 'success');
        }

        // Funzione per salvare i dati del prompt in localStorage
        function saveDraftData() {
            const data = {
                theme: document.body.classList.contains('dark-mode') ? 'dark' : 'light',
                musicState: musicPlayerContainer.classList.contains('show') ? 'show' : 'hidden', // NEW
                titoloStoria: document.getElementById('titoloStoria').value.trim(),
                selectedGenres: selectedGenres, // Salva l'array di generi
                tonoStile: document.getElementById('tonoStile').value.trim(),
                personaggiPrincipali: document.getElementById('personaggiPrincipali').value.trim(),
                ambientazioneGenerale: document.getElementById('ambientazioneGenerale').value.trim(),
                protocolParams: { // Salva i parametri personalizzati del protocollo
                    lengthP1: document.getElementById('lengthP1').value.trim(),
                    atmP1: document.getElementById('atmP1').value.trim(),
                    symP1: document.getElementById('symP1').value.trim(),
                    turnP1: document.getElementById('turnP1').value.trim(),
                },
                transitions: { // Salva i campi di transizione
                    p1p2: document.getElementById('transitionP1P2').value.trim(),
                    p2p3: document.getElementById('transitionP2P3').value.trim(),
                    p3next: document.getElementById('transitionP3Next').value.trim()
                },
                chapters: []
            };

            const chapterSections = document.querySelectorAll('.chapter-section');
            chapterSections.forEach(section => {
                data.chapters.push({
                    title: section.querySelector('.chapter-title-input').value.trim(),
                    context: section.querySelector('.chapter-context-input').value.trim(),
                    start: section.querySelector('.chapter-start-input').value.trim(),
                    startLength: section.querySelector('.chapter-start-length-input').value.trim(),
                    startAtm: section.querySelector('.chapter-start-atm-input').value.trim(),
                    startDialogues: section.querySelector('.chapter-start-dialogues-input').value.trim(), // NEW
                    startChars: section.querySelector('.chapter-start-chars-input').value.trim(),
                    middle: section.querySelector('.chapter-middle-input').value.trim(),
                    middleLength: section.querySelector('.chapter-middle-length-input').value.trim(),
                    middleAtm: section.querySelector('.chapter-middle-atm-input').value.trim(),
                    middleDialogues: section.querySelector('.chapter-middle-dialogues-input').value.trim(), // NEW
                    middleChars: section.querySelector('.chapter-middle-chars-input').value.trim(),
                    end: section.querySelector('.chapter-end-input').value.trim(),
                    endLength: section.querySelector('.chapter-end-length-input').value.trim(),
                    endAtm: section.querySelector('.chapter-end-atm-input').value.trim(),
                    endDialogues: section.querySelector('.chapter-end-dialogues-input').value.trim(), // NEW
                    endChars: section.querySelector('.chapter-end-chars-input').value.trim(),
                    nextContext: section.querySelector('.chapter-next-context-input').value.trim()
                });
            });

            try {
                localStorage.setItem('narrativeGameSave', JSON.stringify(data)); // Save to narrativeGameSave for consistency
                showNotification('Bozza salvata!', 'success');
            } catch (e) {
                showNotification('Errore nel salvataggio.', 'error');
                console.error('Errore salvataggio localStorage: ', e);
            }
        }

        // Funzione per caricare i dati del prompt da localStorage
        function loadDraftData() {
            try {
                const savedData = localStorage.getItem('narrativeGameSave'); // Load from narrativeGameSave
                if (savedData) {
                    const data = JSON.parse(savedData);
                    applyLoadedData(data);
                    showNotification('Campi ripristinati dalla bozza caricata!', 'success');
                }
            } catch (e) {
                showNotification('Nessuna bozza salvata o errore nel caricamento.', 'error');
                console.error('Errore caricamento localStorage: ', e);
            }
        }

        // Funzione per applicare i dati caricati (da localStorage o da JSON)
        function applyLoadedData(data) {
            // Applica il tema
            if (data.theme === 'dark') {
                document.body.classList.add('dark-mode');
                themeIcon.className = 'fas fa-sun';
                themeIconGame.className = 'fas fa-sun';
            } else {
                document.body.classList.remove('dark-mode');
                themeIcon.className = 'fas fa-moon';
                themeIconGame.className = 'fas fa-moon';
            }

            // Applica lo stato della musica
            if (data.musicState === 'show') {
                musicPlayerContainer.classList.add('show');
                audioPlayerIframe.src = audioSrc; // Ripristina src
            } else {
                musicPlayerContainer.classList.remove('show');
                audioPlayerIframe.src = ''; // Assicurati che sia fermo
            }

            document.getElementById('titoloStoria').value = data.titoloStoria || '';
            document.getElementById('tonoStile').value = data.tonoStile || '';
            document.getElementById('personaggiPrincipali').value = data.personaggiPrincipali || '';
            document.getElementById('ambientazioneGenerale').value = data.ambientazioneGenerale || '';

            // Carica i parametri del protocollo
            if (data.protocolParams) {
                document.getElementById('lengthP1').value = data.protocolParams.lengthP1 || '5200';
                document.getElementById('atmP1').value = data.protocolParams.atmP1 || '70';
                document.getElementById('symP1').value = data.protocolParams.symP1 || '3';
                document.getElementById('turnP1').value = data.protocolParams.turnP1 || '800';
            }

            // Carica i campi di transizione
            if (data.transitions) {
                document.getElementById('transitionP1P2').value = data.transitions.p1p2 || '';
                document.getElementById('transitionP2P3').value = data.transitions.p2p3 || '';
                document.getElementById('transitionP3Next').value = data.transitions.p3next || '';
            }

            // Carica i generi selezionati
            selectedGenres = data.selectedGenres || [];
            genreCards.forEach(card => {
                card.classList.remove('active');
                if (selectedGenres.includes(card.dataset.genre)) {
                    card.classList.add('active');
                }
            });

            // Rimuovi tutti i capitoli esistenti prima di caricare
            document.getElementById('chaptersContainer').innerHTML = '';
            chapterCount = 0;

            if (data.chapters && data.chapters.length > 0) {
                data.chapters.forEach(chapter => addChapter(chapter));
            } else {
                // Se la bozza non ha capitoli, aggiungi un capitolo vuoto
                addChapter();
            }
            updateChapterNumbers();
        }

        // Funzione per esportare la bozza come file JSON
        function exportDraftToJson() {
            const data = {
                theme: document.body.classList.contains('dark-mode') ? 'dark' : 'light',
                musicState: musicPlayerContainer.classList.contains('show') ? 'show' : 'hidden', // NEW
                titoloStoria: document.getElementById('titoloStoria').value.trim(),
                selectedGenres: selectedGenres,
                tonoStile: document.getElementById('tonoStile').value.trim(),
                personaggiPrincipali: document.getElementById('personaggiPrincipali').value.trim(),
                ambientazioneGenerale: document.getElementById('ambientazioneGenerale').value.trim(),
                protocolParams: {
                    lengthP1: document.getElementById('lengthP1').value.trim(),
                    atmP1: document.getElementById('atmP1').value.trim(),
                    symP1: document.getElementById('symP1').value.trim(),
                    turnP1: document.getElementById('turnP1').value.trim(),
                },
                transitions: {
                    p1p2: document.getElementById('transitionP1P2').value.trim(),
                    p2p3: document.getElementById('transitionP2P3').value.trim(),
                    p3next: document.getElementById('transitionP3Next').value.trim()
                },
                chapters: []
            };

            const chapterSections = document.querySelectorAll('.chapter-section');
            chapterSections.forEach(section => {
                data.chapters.push({
                    title: section.querySelector('.chapter-title-input').value.trim(),
                    context: section.querySelector('.chapter-context-input').value.trim(),
                    start: section.querySelector('.chapter-start-input').value.trim(),
                    startLength: section.querySelector('.chapter-start-length-input').value.trim(),
                    startAtm: section.querySelector('.chapter-start-atm-input').value.trim(),
                    startDialogues: section.querySelector('.chapter-start-dialogues-input').value.trim(), // NEW
                    startChars: section.querySelector('.chapter-start-chars-input').value.trim(),
                    middle: section.querySelector('.chapter-middle-input').value.trim(),
                    middleLength: section.querySelector('.chapter-middle-length-input').value.trim(),
                    middleAtm: section.querySelector('.chapter-middle-atm-input').value.trim(),
                    middleDialogues: section.querySelector('.chapter-middle-dialogues-input').value.trim(), // NEW
                    middleChars: section.querySelector('.chapter-middle-chars-input').value.trim(),
                    end: section.querySelector('.chapter-end-input').value.trim(),
                    endLength: section.querySelector('.chapter-end-length-input').value.trim(),
                    endAtm: section.querySelector('.chapter-end-atm-input').value.trim(),
                    endDialogues: section.querySelector('.chapter-end-dialogues-input').value.trim(), // NEW
                    endChars: section.querySelector('.chapter-end-chars-input').value.trim(),
                    nextContext: section.querySelector('.chapter-next-context-input').value.trim()
                });
            });

            const jsonString = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'bozza_prompt_narrativo.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showNotification('Bozza esportata come JSON!', 'success');
        }

        // Funzione per importare la bozza da un file JSON
        function importDraftFromJson(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    applyLoadedData(data);
                    showNotification('Bozza importata con successo!', 'success');
                } catch (error) {
                    showNotification('Errore nell\'importazione del file JSON. Assicurati che sia un formato valido.', 'error');
                    console.error('Errore importazione JSON: ', error);
                }
            };
            reader.readAsText(file);
        }

        // Funzione per resettare tutti i campi del form
        function resetForm(addInitialChapter = true) {
            document.getElementById('titoloStoria').value = '';
            document.getElementById('tonoStile').value = '';
            document.getElementById('personaggiPrincipali').value = '';
            document.getElementById('ambientazioneGenerale').value = '';
            document.getElementById('promptOutput').textContent = '';


            // Resetta i parametri personalizzati del protocollo
            document.getElementById('lengthP1').value = '5200';
            document.getElementById('atmP1').value = '70';
            document.getElementById('symP1').value = '3';
            document.getElementById('turnP1').value = '800';

            // Resetta i campi di transizione
            document.getElementById('transitionP1P2').value = '';
            document.getElementById('transitionP2P3').value = '';
            document.getElementById('transitionP3Next').value = '';

            // Resetta selezione genere
            genreCards.forEach(card => card.classList.remove('active'));
            selectedGenres = []; // Svuota l'array dei generi selezionati
            
            const chaptersContainer = document.getElementById('chaptersContainer');
            chaptersContainer.innerHTML = '';

            chapterCount = 0;
            if (addInitialChapter) {
                addChapter();
            }
            updateChapterNumbers();
            showNotification('Campi resettati!', 'info');
        }

        // --- Dati per la compilazione casuale ---
        const titoli = [
            "L'Ultimo Eco di Silenzio", "Il Segreto della Città Sommersa di Aethel", "Cronache di Asteria: L'Ascesa dei Guardiani", "La Caduta della Stella Caduta", "Sussurri nel Vuoto Cosmico", "Il Giardino delle Illusioni Perdute", "Oltre il Velo della Realtà", "La Macchina dei Sogni Infranti", "Il Custode del Tempo Sospeso", "L'Ascesa dell'Ombra Antica", "Il Manoscritto Dimenticato", "Notte di Sangue a Blackwood", "L'Eredità della Villa Malefica", "Il Rituale Silente", "Orgoglio e Pregiudizio 2.0", "Le Avventure di Oliver Twist: Il Ritorno", "Un Amore ai Tempi del Colera: La Nuova Generazione",
            "Il Canto della Sirena Perduta", "Le Rune di Ghiaccio", "La Biblioteca Nascosta di Eldoria", "Il Labirinto del Sonno", "L'Occhio del Leviatano", "Il Respiro del Vulcano Dormiente", "Le Cronache del Vento Sospeso", "La Chiave del Mondo Sottosopra", "Il Patto delle Anime Gemelle", "Il Codice del Drago Smeraldo", "L'Incubo del Corvo", "Il Sussurro della Cenere", "La Profezia delle Ossa", "Il Segno del Mietitore", "Il Valzer dell'Addio", "Il Ritratto di Dorian Gray: Una Nuova Vita", "Grandi Speranze: Il Futuro di Pip", "Il Conte di Montecristo: La Vendetta Continua",
            "L'Ombra sulla Brughiera", "Il Mistero di Villa Blackwood", "La Furia del Signore Oscuro", "Il Segreto del Portale Dimensionale", "Il Cuore della Galassia Morente", "L'Ultima Fortezza", "La Caccia al Necromante", "Il Ritorno degli Antichi Dei", "La Ballata del Cavaliere Caduto", "Il Sogno della Farfalla Nera", "Il Giuramento del Silenzio", "La Danza delle Stelle Cadenti", "Il Prisma della Verità", "L'Eclissi del Sole Nero", "La Cattedrale di Cristallo", "Il Gioco dell'Immortale", "Il Silenzio dei Morti", "La Leggenda del Lupo Solitario", "Il Sentiero delle Anime Perdute", "Il Richiamo del Vuoto",
            "Il Destino del Viaggiatore", "L'Ultimo Respiro del Mondo", "Il Risveglio della Bestia", "La Città Sospesa", "Il Custode dei Sogni", "La Ragnatela del Tempo", "Il Gioco delle Ombre", "La Caduta del Titano", "Il Fiore di Cenere", "Il Canto del Ghiaccio", "L'Eco del Passato", "Il Segreto del Fiume", "La Torre del Silenzio", "Il Volo del Falco", "Il Dono della Notte", "Il Labirinto dei Ricordi", "La Voce del Deserto", "Il Cuore di Pietra", "La Profezia del Corvo Bianco", "Il Velo dell'Oblivio",
            "Il Labirinto di Specchi", "La Caccia al Fantasma", "Il Giuramento di Sangue", "La Leggenda del Golem", "Il Patto con il Diavolo", "La Maledizione del Faraone", "Il Castello Infernale", "La Notte dei Lupi Mannari", "Il Risveglio del Vampiro", "La Stirpe della Strega", "Il Segreto del Cimitero", "La Casa Stregata", "L'Ultima Esecuzione", "Il Giudizio Finale", "La Fiera delle Illusioni", "Il Circo degli Orrori", "La Bambola Maledetta", "Il Silenzio della Tomba", "Il Demone nella Bottiglia", "L'Ombra del Boia",
            "Il Tesoro Nascosto", "Il Diario Segreto", "L'Ultima Lettera", "Il Mistero della Vecchia Signora", "La Scomparsa del Dottore", "Il Caso del Diamante Rubato", "L'Eredità Contesa", "Il Segreto della Governatrice", "L'Intrigo a Palazzo", "Il Viaggio Inaspettato", "La Vendetta del Marinaio", "Il Duello al Tramonto", "Il Patto dei Gentiluomini", "La Fuga del Prigioniero", "Il Segno del Traditore", "La Promessa Mantenuta", "Il Ritorno del Figliol Prodigo", "Il Giudizio del Popolo", "La Scelta della Regina", "Il Destino del Soldato",
            "Il Sussurro della Foresta Proibita", "L'Ultimo Respiro del Drago", "La Città Sotto la Sabbia", "Il Cuore di Cristallo", "Il Giuramento delle Sorelle d'Acciaio", "La Profezia del Corvo Bianco", "Il Labirinto Senza Fine", "La Caduta del Regno di Zenith", "Il Canto della Tempesta", "L'Occhio del Guardiano", "Il Segreto della Montagna Nera", "La Danza dei Fantasmi", "Il Patto Oscuro", "La Rinascita dell'Antico Male", "Il Ponte tra i Mondi", "Il Gioco del Destino", "La Notte dei Mille Soli", "Il Dono della Strega", "Il Sentiero della Redenzione", "L'Eco della Battaglia",
            "La Leggenda del Lupo Solitario", "Il Richiamo del Vuoto", "Il Destino del Viaggiatore", "L'Ultimo Respiro del Mondo", "Il Risveglio della Bestia", "La Città Sospesa", "Il Custode dei Sogni", "La Ragnatela del Tempo", "Il Gioco delle Ombre", "La Caduta del Titano", "Il Fiore di Cenere", "Il Canto del Ghiaccio", "L'Eco del Passato", "Il Segreto del Fiume", "La Torre del Silenzio", "Il Volo del Falco", "Il Dono della Notte", "Il Labirinto dei Ricordi", "La Voce del Deserto", "Il Cuore di Pietra", "La Profezia del Corvo Bianco", "Il Velo dell'Oblivio",
            "Il Mistero della Nave Fantasma", "L'Isola Dimenticata", "La Cripta del Silenzio", "Il Segno del Demone", "La Voce dall'Abisso", "Il Rituale della Luna Rossa", "La Casa delle Anime Perdute", "Il Giardino delle Lacrime", "L'Ultimo Respiro del Giusto", "Il Patto di Sangue", "La Furia del Mare", "Il Tesoro del Pirata Maledetto", "Il Segreto della Strega del Mare", "La Nebbia Eterna", "Il Faro della Disperazione", "Il Canto delle Sirene Oscure", "La Maledizione del Relitto", "Il Cuore dell'Oceano", "Il Richiamo della Profondità", "Il Giuramento del Marinaio Fantasma",
            "L'Enigma della Sfera Celeste", "Il Codice del Tempo Perduto", "Il Destino del Crononauta", "La Chiave del Multiverso", "La Ribellione dei Sintetici", "Il Segreto dell'Albero Cosmico", "Le Leggi del Vuoto", "La Voce delle Stelle Morenti", "Il Giuramento del Guardiano Galattico", "L'Eclissi del Cuore Nero",
            "Il Silenzio della Città Morta", "La Profezia del Sangue Antico", "Il Patto delle Ombre", "La Notte del Risveglio", "L'Ultimo Inverno", "Il Canto della Distruzione", "Il Labirinto della Mente", "La Maschera della Verità", "Il Gioco del Fato", "La Resa dei Conti",
            "Il Diario del Folle", "La Casa sull'Orlo del Mondo", "Il Sussurro della Follia", "La Danza Macabra", "Il Patto con l'Innominabile", "L'Incubo Ricorrente", "Il Segno sulla Pelle", "La Bambola Vivente", "La Voce dal Sottosuolo", "Il Circo delle Anime Perdute",
            "L'Ultimo Custode", "Il Risveglio del Sonno", "La Caccia al Sogno", "Il Giardino delle Meraviglie", "Il Ponte dei Sospiri", "La Biblioteca dei Mondi", "Il Segreto del Viaggiatore", "La Caduta della Stella", "Il Canto della Creazione", "L'Eco dell'Infinito",
            "Il Cuore del Ghiaccio", "La Fiamma Nascosta", "Il Sentiero della Luce", "L'Ombra del Drago", "Il Dono del Corvo", "La Profezia del Lupo", "Il Velo della Notte", "Il Giuramento dell'Alba", "La Danza del Sole", "Il Richiamo della Luna",
            "L'Enigma del Manoscritto", "Il Segreto della Cripta", "La Voce del Passato", "Il Patto Silente", "La Notte della Verità", "Il Risveglio dell'Antico", "Il Gioco della Mente", "La Maschera della Follia", "Il Dono del Silenzio", "La Caduta dell'Eroe"
        ];

        const toniStili = [
            "Cupo e atmosferico, con un tocco di realismo magico, ispirato a Gabriel García Márquez.",
            "Leggero e umoristico, con dialoghi brillanti e ritmo incalzante, alla Terry Pratchett.",
            "Epico e avventuroso, ispirato a saghe fantasy classiche, con elementi alla Tolkien e Robert Jordan.",
            "Intenso e introspettivo, focalizzato sulla psicologia dei personaggi, con richiami a Virginia Woolf e Fyodor Dostoevsky.",
            "Distopico e crudo, con un'analisi sociale profonda, stile George Orwell o Aldous Huxley.",
            "Noir e misterioso, con un'atmosfera di suspense costante, alla Raymond Chandler o Agatha Christie.",
            "Poetico e simbolico, con un linguaggio evocativo, stile Italo Calvino o Jorge Luis Borges.",
            "Action-packed e adrenalinico, con scene d'azione mozzafiato, ispirato a Tom Clancy o Lee Child.",
            "Romantico e drammatico, con un focus sulle relazioni umane e i dilemmi morali, stile Jane Austen o Emily Brontë.",
            "Satirico e irriverente, con un umorismo nero e critiche sociali, alla Kurt Vonnegut o Jonathan Swift.",
            "Horror psicologico e inquietante, con un'atmosfera di terrore crescente, alla Shirley Jackson o H.P. Lovecraft.",
            "Gotico e romantico, con elementi soprannaturali e dramma emotivo, alla Mary Shelley o Bram Stoker.",
            "Thriller paranormale con elementi di indagine e mistero, stile Stephen King o Dean Koontz.",
            "Realismo magico con un tocco di malinconia e meraviglia, alla Isabel Allende o Haruki Murakami.",
            "Commedia di costume con un'attenzione ai dettagli sociali e alle relazioni, alla Jane Austen o Oscar Wilde.",
            "Folk horror, con un'atmosfera di crescente disagio e riti ancestrali, alla Robert Eggers.",
            "Cyberpunk distopico, con un focus sulla tecnologia e l'alienazione, alla William Gibson.",
            "Fantasy urbano, dove la magia si intreccia con la vita quotidiana moderna, alla Neil Gaiman.",
            "Satira sociale con un umorismo tagliente e personaggi eccentrici, alla Evelyn Waugh.",
            "Thriller politico con intrighi complessi e giochi di potere, alla John le Carré.",
            "Romanzo di formazione, che segue la crescita e le esperienze di un giovane protagonista, alla J.D. Salinger.",
            "Steampunk, con un'estetica vittoriana e invenzioni a vapore, alla Jules Verne.",
            "Post-apocalittico, con un'enfasi sulla sopravvivenza e la ricostruzione, alla Cormac McCarthy.",
            "Giallo classico, con un detective brillante e un mistero da risolvere, alla Arthur Conan Doyle.",
            "Narrativa storica, con una ricostruzione accurata di un'epoca passata, alla Umberto Eco.",
            "Horror cosmico, con entità aliene e follia incombente, alla H.P. Lovecraft.",
            "Commedia romantica, con equivoci e lieto fine, alla Nora Ephron.",
            "Dramma familiare, esplorando le dinamiche complesse e i segreti di una famiglia, alla Jonathan Franzen.",
            "Fantasy epico, con vasti mondi e conflitti su larga scala, alla Brandon Sanderson.",
            "Slice of life, focalizzato sulla quotidianità e le piccole gioie/dolori, alla Alice Munro.",
            "Surreale e onirico, con elementi di sogno e realtà che si fondono, ispirato a Franz Kafka o Haruki Murakami.",
            "Avventura pulp, con azione frenetica e personaggi esagerati, alla Indiana Jones o Doc Savage.",
            "Mistero gotico, con atmosfere cupe, segreti di famiglia e elementi soprannaturali, alla Edgar Allan Poe.",
            "Realismo sporco, con un linguaggio schietto e personaggi marginali, alla Charles Bukowski o Raymond Carver.",
            "Fantastico fiabesco, con un tono da favola per adulti e creature magiche, alla Angela Carter.",
            "Distopico ecologico, focalizzato sui disastri ambientali e la lotta per la sopravvivenza, alla Paolo Bacigalupi.",
            "Thriller medico, con intrighi nel mondo della medicina e cospirazioni, alla Robin Cook.",
            "Romanzo di spionaggio, con doppi giochi, agenti segreti e suspense internazionale, alla Ian Fleming.",
            "Commedia nera, con umorismo macabro e situazioni assurde, alla Quentin Tarantino.",
            "Narrativa sportiva, con un focus sulla competizione, la disciplina e il dramma personale, alla Bernard Malamud.",
            "Horror body, con trasformazioni fisiche e orrori viscerali, alla David Cronenberg.",
            "Fantasy politico, con intrighi di corte, guerre per il potere e magia, alla George R.R. Martin.",
            "Science fantasy, che mescola elementi di fantascienza e fantasy in un unico mondo, alla Gene Wolfe.",
            "Narrativa di viaggio, con un focus sull'esplorazione e la scoperta culturale, alla Jack Kerouac.",
            "Dramma giudiziario, con processi, avvocati e la ricerca della giustizia, alla John Grisham.",
            "Horror psicologico, con una lenta discesa nella follia e terrore mentale, alla Robert Bloch.",
            "Romanzo epistolare, raccontato attraverso lettere o documenti, alla Bram Stoker (Dracula).",
            "Commedia satirica, che critica la società attraverso l'umorismo, alla Voltaire (Candido).",
            "Narrativa di sopravvivenza, con personaggi che lottano contro gli elementi o altre minacce, alla Jack London.",
            "Fantastico storico, che inserisce elementi magici in un contesto storico reale, alla Susanna Clarke.",
            "Fantastico contemporaneo, dove la magia si nasconde nel mondo moderno, alla Holly Black.",
            "Thriller legale, con avvocati, tribunali e misteri, alla Scott Turo",
            "Narrativa di formazione, con un focus sulla crescita personale e le sfide dell'adolescenza, alla S.E. Hinton.",
            "Mistero storico, che combina elementi storici con un enigma da risolvere, alla C.J. Sansom.",
            "Horror gotico, con ambientazioni cupe, segreti di famiglia e un'atmosfera di terrore, alla Daphne du Maurier.",
            "Fantastico oscuro, con elementi horror e fantasy che si fondono, alla China Miéville.",
            "Romanzo di guerra, che esplora le esperienze dei soldati e le conseguenze del conflitto, alla Erich Maria Remarque.",
            "Satira politica, che critica il sistema politico attraverso l'umorismo, alla George Bernard Shaw.",
            "Narrativa di viaggio nel tempo, con paradossi e avventure attraverso le epoche, alla H.G. Wells.",
            "Dramma psicologico, che esplora la mente umana e i suoi conflitti interni, alla Patricia Highsmith.",
            "Fantastico mitologico, che rielabora miti e leggende in nuove storie, alla Rick Riordan.",
            "Thriller tecnologico, con cospirazioni legate alla tecnologia e all'intelligenza artificiale, alla Michael Crichton.",
            "Romanzo di avventura, con esplorazioni, scoperte e pericoli, alla Robert Louis Stevenson.",
            "Commedia romantica, con equivoci e lieto fine, alla Helen Fielding.",
            "Narrativa di fantasmi, con storie di spettri e case infestate, alla M.R. James.",
            "Fantastico per ragazzi, con avventure, magia e crescita personale, alla J.K. Rowling.",
            "Thriller di spionaggio, con agenti segreti, intrighi internazionali e suspense, alla Frederick Forsyth.",
            "Romanzo di formazione, con un focus sulla crescita e le esperienze di un giovane protagonista, alla Harper Lee.",
            "Fantastico scientifico, che unisce elementi di fantascienza e fantasy, alla Ursula K. Le Guin."
        ];

        const personaggi = [
            "Elara (giovane maga, coraggiosa ma ingenua, legata a un antico spirito), Kael (guerriero solitario, esperto di spade, con un passato misterioso).",
            "Detective Miller (cinico ma brillante investigatore, afflitto da incubi ricorrenti), Sarah (scienziata idealista, scopritrice di una tecnologia rivoluzionaria).",
            "Jax (ribelle carismatico, leader di una fazione sotterranea, con un segreto sulla sua origine), Anya (ingegnere geniale, pragmatica, crea dispositivi per la resistenza).",
            "Prof. Aris (archeologo eccentrico, alla ricerca di un manufatto antico con poteri sconosciuti), Lyra (guida locale, misteriosa e abile cacciatrice, custode di segreti ancestrali).",
            "Leo (artista tormentato, con un passato oscuro legato a un culto segreto), Clara (musicista enigmatica, portatrice di una melodia che svela la verità).",
            "Il Capitano Valerius (veterano di guerra, stanco ma onorevole, guida una nave spaziale alla deriva), Zylos (alieno enigmatico, con poteri sconosciuti, l'ultimo della sua specie).",
            "Dr. Evelyn Reed (psichiatra forense, specializzata in profili criminali complessi, perseguitata da un caso irrisolto), Agente Ben Carter (giovane e ambizioso agente FBI, scettico ma determinato).",
            "Aella (ladra agile e astuta, con un codice morale tutto suo, cerca vendetta per la sua famiglia), Marcus (nobile decaduto, in cerca di redenzione, costretto a lavorare con Aella).",
            "Il Monaco Silente (maestro di arti marziali, custode di antiche tradizioni, vive in un tempio isolato), Kai (giovane apprendista, impulsivo e talentoso, destinato a grandi cose).",
            "Aurora (hacker geniale, specializzata in sicurezza informatica, scopre una cospirazione globale), Victor (ex-agente segreto, con una vasta rete di contatti, la sua ex mentore)."
        ];

        const ambientazioni = [
            "Un regno medievale devastato dalla guerra, con antiche rovine e foreste incantate.",
            "Una stazione spaziale isolata ai confini della galassia, con tecnologie avanzate e misteri cosmici.",
            "Una città futuristica cyberpunk, illuminata da neon e dominata da megacorporazioni.",
            "Un villaggio costiero battuto dal vento, con un faro solitario e leggende marine.",
            "Un deserto post-apocalittico, dove i sopravvissuti lottano per l'acqua e la speranza.",
            "Una biblioteca infinita, dove ogni libro è un portale per un'altra realtà.",
            "Un sottomarino di ricerca nelle profondità oceaniche, alla scoperta di forme di vita sconosciute.",
            "Una dimensione onirica, dove la logica si piega e i sogni prendono forma.",
            "Un'antica tomba egizia, piena di trappole e maledizioni millenarie.",
            "Un mondo fantasy con draghi, magie e regni in conflitto.",
            "Una scuola di magia nascosta, dove giovani studenti imparano a controllare i loro poteri.",
            "Una metropoli gotica, percorsa da detective privati e creature della notte.",
            "Una colonia marziana autosufficiente, con segreti sepolti sotto la sabbia rossa.",
            "Una foresta pluviale incontaminata, con tribù indigene e pericoli naturali.",
            "Un manicomio abbandonato, teatro di esperimenti oscuri e orrori psicologici.",
            "Un'isola tropicale remota, con rovine di un'antica civiltà e fenomeni inspiegabili.",
            "Una stazione di ricerca artica, isolata e minacciata da un'entità sconosciuta.",
            "Un labirinto sotterraneo, pieno di creature mostruose e tesori perduti.",
            "Una nave fantasma che naviga tra le nebbie, condannata a un'eterna traversata.",
            "Un circo itinerante, dove gli artisti nascondono segreti e poteri soprannaturali.",
            "Un regno sottomarino, abitato da sirene e altre creature marine mitologiche.",
            "Una città fluttuante nel cielo, alimentata da cristalli magici e abitata da esseri alati.",
            "Un mondo parallelo, accessibile solo attraverso specchi o portali nascosti.",
            "Una prigione spaziale di massima sicurezza, dove i criminali più pericolosi sono rinchiusi.",
            "Un'accademia per cacciatori di mostri, dove si addestrano i futuri eroi.",
            "Un'antica piramide azteca, con trappole mortali e un tesoro maledetto.",
            "Una città medievale assediata, con cavalieri, assedi e intrighi di corte.",
            "Un treno transcontinental di lusso, teatro di un misterioso omicidio.",
            "Una base segreta sotto la superficie lunare, con esperimenti scientifici proibiti.",
            "Un mondo post-apocalittico invaso da piante carnivore giganti.",
            "Una città vittoriana avvolta nella nebbia, con investigatori privati e misteri irrisolti.",
            "Un'astronave coloniale in viaggio verso un nuovo mondo, con un sabotatore a bordo.",
            "Un'antica rovina romana, dove un culto segreto pratica riti proibiti.",
            "Una foresta incantata, abitata da fate, elfi e creature magiche.",
            "Un laboratorio sotterraneo, dove scienziati pazzi conducono esperimenti genetici.",
            "Un'isola vulcanica attiva, con templi antichi e un'entità dormiente.",
            "Una città sottomarina futuristica, alimentata da energia geotermica.",
            "Un castello infestato, con fantasmi e segreti di famiglia.",
            "Un mondo di ghiaccio eterno, dove i sopravvissuti vivono in città sotterranee.",
            "Una dimensione oscura, popolata da demoni e ombre.",
            "Un parco a tema abbandonato, dove le attrazioni prendono vita di notte.",
            "Una stazione spaziale in quarantena, con un virus alieno in diffusione.",
            "Un villaggio montano isolato, con leggende di creature misteriose.",
            "Un'antica città sotterranea, abitata da una civiltà dimenticata.",
            "Una nave da crociera di lusso, dove un assassino si aggira indisturbato.",
            "Un mondo desertico con città scavate nella roccia e tempeste di sabbia.",
            "Una foresta pietrificata, dove tutto è immobile e silenzioso.",
            "Una stazione di ricerca su un pianeta alieno, con flora e fauna ostili.",
            "Un teatro dell'opera abbandonato, infestato da un fantasma cantante.",
            "Una città costruita all'interno di un gigantesco albero.",
            "Un mondo post-apocalittico coperto di neve e ghiaccio, con creature mutanti.",
            "Una dimensione speculare, dove tutto è il contrario del mondo reale.",
            "Una base militare segreta, dove si sviluppano armi biologiche.",
            "Un'isola paradisiaca, che nasconde un'antica maledizione.",
            "Una città sommersa, dove i resti di una civiltà perduta giacciono sul fondo del mare.",
            "Un treno blindato che attraversa un paesaggio desolato, con un carico prezioso.",
            "Una foresta di funghi giganti, con creature bioluminescenti.",
            "Un'astronave alla deriva nello spazio profondo, con un equipaggio in ibernazione.",
            "Un manicomio vittoriano, con pazienti tormentati e un medico sadico.",
            "Un mondo di nuvole, dove le città fluttuano tra le formazioni nuvolose.",
            "Una città sotterranea illuminata da cristalli, con una società gerarchica.",
            "Un'antica fortezza in cima a una montagna, assediata da un esercito oscuro.",
            "Una base di ricerca su un asteroide, con risorse preziose e pericoli cosmici.",
            "Un mondo di sabbie mobili, dove le città sono costruite su piattaforme galleggianti.",
            "Una foresta di alberi parlanti, con spiriti della natura e antichi segreti.",
            "Una stazione di ricerca in un laboratorio segreto in una base antartica, con scoperte che potrebbero cambiare il mondo.",
            "Un'isola deserta, con un solo sopravvissuto e un mistero da risolvere.",
            "Una città futuristica con veicoli volanti e robot intelligenti.",
            "Un mondo di acqua, dove le città sono costruite su isole galleggianti e sottomarine.",
            "Una foresta oscura e proibita, con creature malvagie e antiche maledizioni.",
            "Una stazione spaziale in orbita attorno a un buco nero, con fenomeni inspiegabili.",
            "Un villaggio isolato in una valle remota, con tradizioni antiche e un segreto oscuro.",
            "Un'antica città sotterranea, con labirinti e trappole mortali.",
            "Una nave pirata che naviga tra le isole tropicali, in cerca di tesori nascosti.",
            "Un mondo di fuoco, con vulcani attivi e creature resistenti al calore.",
            "Una città nascosta tra le montagne, raggiungibile solo attraverso un sentiero segreto.",
            "Una base sottomarina segreta, con scienziati che studiano creature marine giganti.",
            "Un castello in rovina, infestato da fantasmi e spiriti vendicativi.",
            "Un mondo di cristallo, dove tutto è trasparente e fragile.",
            "Una città nel cielo, costruita su isole fluttuanti collegate da ponti.",
            "Una foresta di ghiaccio, con alberi e animali congelati.",
            "Una stazione di ricerca su un pianeta gassoso, con tempeste e fenomeni atmosferici estremi.",
            "Un villaggio di pescatori, con leggende di mostri marini e tesori sommersi.",
            "Un'antica biblioteca sotterranea, con manoscritti proibiti e conoscenze perdute.",
            "Una nave spaziale alla deriva, con un equipaggio in animazione sospesa.",
            "Un mondo di rovine, dove antiche civiltà sono state distrutte da una catastrofe.",
            "Una città costruita all'interno di un gigantesco grotta, illuminata da funghi bioluminescenti.",
            "Una foresta di alberi giganti, con case costruite tra i rami.",
            "Una stazione di ricerca su un pianeta desertico, con tempeste di sabbia e creature sotterranee.",
            "Un villaggio isolato in una palude, con creature misteriose e segreti antichi.",
            "Una città costruita su un gigantesco albero, con ponti e piattaforme aeree.",
            "Un mondo di vapore, con macchine a vapore e città industriali.",
            "Una foresta di funghi giganti, con creature che vivono in simbiosi con i funghi.",
            "Una stazione di ricerca su un pianeta vulcanico, con fiumi di lava e geyser.",
            "Un villaggio isolato in una valle nascosta, con una comunità autosufficiente.",
            "Una città costruita su un gigantesco iceberg, che naviga nell'oceano artico.",
            "Una foresta di cristallo, con alberi e piante fatte di cristallo.",
            "Una stazione di ricerca su un un pianeta acquatico, con città sottomarine e creature marine giganti.",
            "Un villaggio isolato in una foresta pluviale, con tribù indigene e animali esotici.",
            "Una città costruita all'interno di un gigantesco vulcano spento.",
            "Una foresta di metallo, con alberi e piante fatti di metallo.",
            "Una stazione di ricerca su un pianeta ghiacciato, con tempeste di neve e aurore boreali.",
            "Un villaggio isolato in un deserto di sale, con miraggi e tempeste di sale.",
            "Una città costruita su una gigantesca balena, che naviga nell'oceano.",
            "Una foresta di luce, con alberi e piante che emettono luce.",
            "Una stazione di ricerca su un pianeta di fuoco, con fiumi di lava e vulcani attivi.",
            "Un villaggio isolato in una giungla fitta, con animali selvaggi e piante velenose.",
            "Una città costruita su un gigantesco fungo, con case scavate nel fungo.",
            "Una foresta di ossa, con alberi fatti di ossa e creature scheletriche.",
            "Una stazione di ricerca su un pianeta di gas, con nuvole tossiche e fulmini giganti.",
            "Un villaggio isolato in una tundra ghiacciata, con igloo e orsi polari.",
            "Una città costruita su un gigantesco insetto, che si muove nel paesaggio.",
            "Una foresta di gemme, con alberi e piante fatte di gemme.",
            "Una stazione di ricerca su un pianeta di roccia, con canyon profondi e grotte misteriose.",
            "Un villaggio isolato in una savana arida, con animali selvaggi e tempeste di polvere.",
            "Una città costruita su un gigantesco fiore, che si apre e si chiude con il sole.",
            "Una foresta di specchi, con alberi e piante che riflettono la realtà in modo distorto.",
            "Una stazione di ricerca su un pianeta di fango, con paludi e creature melmose.",
            "Un villaggio isolato in una foresta di bambù, con case costruite sul bambù.",
            "Una città costruita su un gigantesco cristallo, che emette luce e energia."
        ];


        const chapterTitles = [
            "L'Inizio del Viaggio", "Un'Ombra nel Buio", "La Rivelazione", "Il Punto di Non Ritorno", "L'Ultima Speranza",
            "Il Primo Contatto", "La Cospirazione", "Il Sacrificio", "La Nuova Alba", "Il Velo Strappato",
            "Sussurri dal Passato", "Il Cuore del Labirinto", "La Prova del Fuoco", "L'Eredità Dimenticata", "La Caduta del Titano",
            "Il Risveglio", "La Fuga", "L'Inseguimento", "Il Rifugio", "La Scelta",
            "La Minaccia Incombente", "Il Patto", "La Tempesta", "La Resa dei Conti", "L'Epilogo",
            "Il Segreto Svelato", "L'Inganno", "La Verità Nascosta", "La Battaglia Finale", "Un Nuovo Inizio",
            "L'Ombra Crescente", "Il Richiamo", "La Ricerca", "Il Confronto", "La Riscoperta",
            "Il Sogno Infranto", "La Resilienza", "La Vendetta", "La Redenzione", "Il Destino",
            "L'Ultimo Respiro", "La Speranza", "Il Miracolo", "Il Giuramento", "La Promessa",
            "Il Silenzio", "L'Eco", "Il Ricordo", "La Follia", "La Salvezza"
        ];

        const chapterStarts = [
            "La pioggia battente sferzava i vetri della vecchia biblioteca, mentre Elara, con un libro polveroso tra le mani, sentiva un brivido percorrere la schiena. Una pagina ingiallita parlava di un antico spirito legato al suo lignaggio. L'atmosfera era cupa e carica di un'inquietudine sottile.",
            "Il detective Miller si svegliò di soprassalto, l'ennesimo incubo a tormentarlo. La città, fuori dalla finestra, era un mosaico di luci al neon e ombre. Un nuovo caso lo attendeva, un omicidio inspiegabile che sembrava sfidare ogni logica. Il caffè amaro era l'unica cosa che lo teneva ancorato alla realtà.",
            "Jax si muoveva furtivo tra i condotti di ventilazione della megacorporazione, il suo obiettivo: un chip di dati contenente prove di corruzione. Sotto di lui, la città brulicava di vita artificiale e disperazione umana. L'aria era densa di ozono e tensione, ogni passo un rischio calcolato.",
            "Il vento sibilava tra le rovine di un tempio dimenticato, mentre il Prof. Aris decifrava un'antica iscrizione. Lyra, la sua guida, teneva d'occhio l'orizzonte, percependo una presenza che non era umana. Il sole tramontava, tingendo il cielo di rosso sangue, presagio di eventi imminenti.",
            "Leo, con le mani sporche di vernice, fissava la tela. Un volto demoniaco lo guardava, un'immagine che non era sua, ma che sembrava emergere dal profondo. La musica di Clara, proveniente dall'appartamento accanto, era l'unica cosa che teneva a bada la follia. L'aria era pesante, carica di un'energia oscura e creativa.",
            "Il Capitano Valerius (veterano di guerra, stanco ma onorevole, guida una nave spaziale alla deriva), Zylos (alieno enigmatico, con poteri sconosciuti, l'ultimo della sua specie).",
            "Dr. Evelyn Reed (psichiatra forense, specializzata in profili criminali complessi, perseguitata da un caso irrisolto), Agente Ben Carter (giovane e ambizioso agente FBI, scettico ma determinato).",
            "Aella (ladra agile e astuta, con un codice morale tutto suo, cerca vendetta per la sua famiglia), Marcus (nobile decaduto, in cerca di redenzione, costretto a lavorare con Aella).",
            "Il Monaco Silente (maestro di arti marziali, custode di antiche tradizioni, vive in un tempio isolato), Kai (giovane apprendista, impulsivo e talentoso, destinato a grandi cose).",
            "Aurora (hacker geniale, specializzata in sicurezza informatica, scopre una cospirazione globale), Victor (ex-agente segreto, con una vasta rete di contatti, la sua ex mentore)."
        ];

        const chapterMiddles = [
            "Elara scoprì che lo spirito era intrappolato in un antico amuleto, e per liberarlo doveva affrontare una serie di prove, ognuna più pericolosa dell'altra. Kael, inizialmente riluttante, si unì a lei, guidato da un senso di dovere e da un passato che lo legava a quell'antica magia. Insieme, si avventurarono in rovine dimenticate, affrontando creature oscure e trappole mortali, mentre l'atmosfera si faceva sempre più opprimente.",
            "Miller e Sarah seguirono una pista che li portò in un laboratorio segreto, dove venivano condotti esperimenti sulla mente umana. Le vittime erano state sottoposte a un'induzione di terrore puro. La loro indagine li portò a confrontarsi con un'organizzazione ombra che cercava di sfruttare queste scoperte per il controllo sociale. La tensione era palpabile, ogni passo li avvicinava a una verità terrificante.",
            "Jax e Anya si infiltrarono nel cuore della megacorporazione, scoprendo che la tecnologia rivoluzionaria era usata per manipolare le masse. Furono costretti a confrontarsi con i loro ex compagni, ora burattini del sistema. La loro fuga fu un susseguirsi di esplosioni e inseguimenti, con l'atmosfera che si faceva sempre più caotica e disperata.",
            "Aris e Lyra si trovarono di fronte a un'entità antica, risvegliata dal manufatto. La creatura, un essere di pura energia, minacciava di consumare ogni cosa. Dovettero unire le loro forze, usando sia l'antica conoscenza che l'istinto primordiale, per cercare di fermarla. L'aria era densa di magia e pericolo, ogni momento una lotta per la sopravvivenza.",
            "Leo si addentrò nel mondo onirico, cercando di capire la fonte delle sue visioni. Clara lo seguì, usando la sua musica per guidarlo attraverso i labirinti della mente. Scoprirono che le visioni erano frammenti di una realtà alternativa, dove un culto oscuro cercava di aprire un portale. L'atmosfera era surreale e inquietante, con il confine tra sogno e realtà che si sfumava.",
            "Valerius e Zylos scoprirono che il segnale proveniva da un'antica nave aliena, abbandonata e piena di pericoli. All'interno, trovarono una tecnologia sconosciuta e una minaccia latente. Dovettero navigare tra trappole e difese automatiche, mentre la tensione aumentava. La loro missione di recupero si trasformò in una lotta per la sopravvivenza.",
            "Reed e Carter si addentrarono nel passato delle vittime, scoprendo un legame comune con un esperimento governativo segreto. Furono ostacolati da agenti ombra che cercavano di coprire la verità. La loro indagine li portò in luoghi oscuri e pericolosi, con l'atmosfera che si faceva sempre più paranoica e claustrofobica.",
            "Aella e Marcus si trovarono intrappolati nel palazzo, costretti a combattere contro le guardie del nobile. La loro vendetta si trasformò in una lotta per la sopravvivenza. Dovettero fare affidamento l'uno sull'altro, scoprendo una fiducia inaspettata. L'aria era carica di violenza e disperazione, ogni colpo un'opportunità per la libertà.",
            "Il Monaco Silente e Kai affrontarono una serie di prove spirituali e fisiche, preparandosi per la minaccia imminente. Kai dovette confrontarsi con la sua rabbia interiore, imparando a controllarla. La loro preparazione fu interrotta da un attacco inaspettato, con l'atmosfera che si faceva tesa e carica di pericolo.",
            "Aurora e Victor si infiltrarono nel server centrale della cospirazione, cercando di disabilitare il loro piano. Furono scoperti e costretti a fuggire, con gli agenti nemici alle calcagna. La loro corsa contro il tempo fu un susseguirsi di decisioni rapide e pericoli, con l'atmosfera che si faceva sempre più frenetica."
        ];

        const chapterEnds = [
            "Elara e Kael riuscirono a liberare lo spirito, ma il processo aprì un portale verso un'altra dimensione, lasciando un cliffhanger per il prossimo capitolo. L'amuleto si frantumò, rilasciando un'onda di energia che scosse le fondamenta del mondo. L'atmosfera era carica di magia e mistero, con la promessa di nuove avventure.",
            "Miller e Sarah smascherarono l'organizzazione, ma il loro leader riuscì a fuggire, lasciando dietro di sé una scia di distruzione e un messaggio criptico. Il caso era chiuso, ma la minaccia persisteva. L'atmosfera era di sollievo, ma con un'ombra di inquietudine per il futuro.",
            "Jax e Anya riuscirono a disabilitare il sistema di controllo, ma la loro azione scatenò una rivolta nella città. Furono costretti a fuggire, lasciando la città nel caos. La loro vittoria fu amara, con l'atmosfera che si faceva caotica e incerta, ma con un barlume di speranza per la libertà.",
            "Aris e Lyra riuscirono a sigillare l'entità, ma il manufatto fu distrutto nel processo. La loro vittoria fu un sollievo, ma il mondo era cambiato per sempre. L'atmosfera era di pace, ma con la consapevolezza che il pericolo era solo sopito.",
            "Leo e Clara riuscirono a chiudere il portale, ma Leo fu costretto a confrontarsi con una parte oscura di sé. La loro esperienza li cambiò per sempre. L'atmosfera era di risoluzione, ma con un'ombra di malinconia per le verità scoperte.",
            "Valerius e Zylos riuscirono a recuperare la tecnologia aliena, ma la loro nave fu danneggiata gravemente. Furono costretti a un atterraggio di fortuna su un pianeta sconosciuto. La loro missione fu un successo, ma la loro sopravvivenza era incerta. L'atmosfera era di trionfo, ma con la minaccia di un nuovo pericolo.",
            "Reed e Carter rivelarono la verità al pubblico, ma furono costretti a nascondersi dalle autorità. La loro indagine fu un successo, ma la loro vita non sarebbe più stata la stessa. L'atmosfera era di giustizia, ma con la consapevolezza che il prezzo era alto.",
            "Aella e Marcus riuscirono a fuggire dal palazzo, ma il nobile giurò vendetta. La loro fuga fu un successo, ma la loro libertà era precaria. L'atmosfera era di libertà, ma con la minaccia di un nuovo scontro.",
            "Il Monaco Silente e Kai affrontarono la minaccia, riuscendo a sconfiggerla. Kai dimostrò la sua forza e saggezza, diventando un vero guerriero. La loro vittoria fu un trionfo, con l'atmosfera che si faceva serena e piena di speranza.",
            "Aurora e Victor riuscirono a svelare la cospirazione, ma furono costretti a fuggire dal paese. La loro missione fu un successo, ma la loro vita era in pericolo. L'atmosfera era di vittoria, ma con la consapevolezza che la lotta non era finita."
        ];

        const chapterLengths = ["1000", "2000", "1500"]; // Caratteri
        const chapterAtms = ["70", "50", "30"]; // Percentuale atmosfera
        const chapterDialogues = ["20", "40", "30"]; // Percentuale dialoghi (NEW)

        const chapterChars = [
            "Il protagonista si sente disorientato, l'ambientazione rivela un dettaglio inquietante.",
            "I personaggi mostrano i primi segni di disagio/curiosità. L'ambientazione rivela un dettaglio inquietante.",
            "I personaggi affrontano un dilemma morale o un ostacolo fisico. L'ambientazione diventa più ostile/rivelatrice.",
            "Un personaggio prende una decisione cruciale. L'ambientazione si trasforma, riflettendo il cambiamento.",
            "Un segreto viene svelato, cambiando la percezione di un personaggio. L'ambientazione si adatta al nuovo stato d'animo.",
            "Un'alleanza si forma o si spezza. L'ambientazione introduce un nuovo elemento di pericolo/speranza.",
            "Il protagonista scopre una nuova abilità o un limite. L'ambientazione presenta una sfida inaspettata.",
            "Un flashback rivela un pezzo del passato di un personaggio. L'ambientazione si carica di significato storico.",
            "Un piccolo trionfo o una sconfitta inaspettata. L'ambientazione si fa più claustrofobica/aperta.",
            "Un personaggio si sacrifica o fa una scoperta personale. L'ambientazione riflette la perdita/la speranza.",
            "Un indizio porta a una svolta inaspettata. L'ambientazione si rivela essere più di quanto sembri.",
            "Un nuovo personaggio viene introdotto, portando con sé un mistero. L'ambientazione si espande, rivelando nuove aree.",
            "Una minaccia si concretizza, costringendo i personaggi a reagire. L'ambientazione diventa un campo di battaglia.",
            "Un oggetto magico o tecnologico viene scoperto, alterando l'equilibrio. L'ambientazione si adatta alla sua presenza.",
            "I personaggi si confrontano con le loro paure più profonde. L'ambientazione diventa un riflesso della psiche.",
            "Un'antica profezia viene decifrata, rivelando un destino ineluttabile. L'ambientazione assume un'aura mistica.",
            "Un viaggio inizia, portando i personaggi in luoghi sconosciuti. L'ambientazione si trasforma, offrendo nuove sfide.",
            "Un enigma deve essere risolto per procedere. L'ambientazione presenta indizi nascosti e trappole.",
            "I personaggi devono fare una scelta difficile, con conseguenze durature. L'ambientazione riflette il peso della decisione.",
            "Un momento di tregua, ma con un'ombra incombente. L'ambientazione offre un falso senso di sicurezza.",
            "La verità viene distorta, mettendo in discussione la realtà. L'ambientazione si fa surreale e ingannevole.",
            "Un'improvvisa svolta nel piano costringe i personaggi a improvvisare. L'ambientazione si rivela più complessa.",
            "Un personaggio rivela un lato inaspettato di sé. L'ambientazione si carica di un nuovo significato emotivo.",
            "Una scoperta archeologica o scientifica cambia la comprensione del mondo. L'ambientazione si trasforma radicalmente.",
            "Un tradimento inaspettato mette a rischio la missione. L'ambientazione diventa un luogo di pericolo imminente.",
            "I personaggi si dividono, affrontando sfide separate. L'ambientazione mostra la sua vastità e le sue insidie.",
            "Un incontro con una creatura leggendaria o un'entità potente. L'ambientazione rivela la sua natura magica/aliena.",
            "Un personaggio è costretto a confrontarsi con un trauma passato. L'ambientazione evoca ricordi dolorosi.",
            "Una corsa contro il tempo per raggiungere un obiettivo cruciale. L'ambientazione si fa più dinamica e frenetica.",
            "I personaggi scoprono una debolezza nel nemico. L'ambientazione offre un'opportunità strategica.",
            "Un segnale di speranza emerge nell'oscurità. L'ambientazione si illumina, offrendo un barlume di possibilità."
        ];

        const nextContexts = [
            "Il capitolo successivo esplorerà le conseguenze immediate di questa scelta e introdurrà un nuovo personaggio enigmatico.",
            "La narrazione si sposterà in una nuova ambientazione, un luogo di rifugio ma anche di nuove minacce, e approfondirà il legame tra i protagonisti.",
            "Il prossimo capitolo si concentrerà sulla ricerca di una soluzione, con un viaggio pericoloso e l'incontro con una fazione inaspettata.",
            "Gli eventi futuri riveleranno la vera natura del manufatto e le sue implicazioni, costringendo i personaggi a confrontarsi con una verità scomoda.",
            "Il capitolo successivo vedrà il protagonista affrontare le ripercussioni delle sue azioni e una minaccia inaspettata emergere dalle ombre.",
            "La storia si addentrerà in un mistero più grande, con l'introduzione di un antagonista potente e la scoperta di un complotto antico.",
            "Il prossimo capitolo esplorerà le dinamiche di un nuovo gruppo di alleati e la preparazione per uno scontro imminente.",
            "La narrazione si concentrerà sulla crescita del personaggio principale e sulla scoperta di poteri latenti, mentre il pericolo si avvicina.",
            "Il capitolo successivo svelerà un tradimento inaspettato e costringerà i personaggi a riconsiderare le loro alleanze.",
            "La storia si avvierà verso il climax, con un'escalation di eventi e la necessità di una decisione finale che cambierà tutto.",
            "Il capitolo seguente approfondirà il passato di un personaggio secondario e rivelerà il suo ruolo cruciale nella trama.",
            "La narrazione si sposterà in un'altra linea temporale o dimensione, complicando ulteriormente la situazione dei protagonisti.",
            "Il prossimo capitolo introdurrà una nuova tecnologia o un antico artefatto che altererà drasticamente il corso degli eventi.",
            "Gli eventi futuri vedranno i personaggi affrontare una prova di sopravvivenza in un ambiente ostile e sconosciuto.",
            "Il capitolo successivo si concentrerà su una fuga disperata o un inseguimento ad alta tensione, con la posta in gioco che aumenta.",
            "La storia rivelerà una verità scioccante sul mondo o sui personaggi, costringendoli a riconsiderare tutto ciò che credevano.",
            "Il prossimo capitolo esplorerà le conseguenze morali delle scelte fatte e il peso delle responsabilità sui protagonisti.",
            "La narrazione si concentrerà su un rituale antico o una cerimonia mistica che svelerà un potere nascosto o una minaccia latente.",
            "Il capitolo successivo vedrà i personaggi formare un'alleanza improbabile con un ex nemico per affrontare una minaccia comune.",
            "La storia si concluderà con un cliffhanger che lascerà il lettore con il fiato sospeso, anticipando un seguito epico.",
            "Il capitolo successivo si aprirà con un evento catastrofico che cambierà per sempre il paesaggio e le dinamiche dei personaggi.",
            "La narrazione esplorerà le conseguenze a lungo termine di una decisione presa in precedenza, con ripercussioni inaspettate.",
            "Il prossimo capitolo introdurrà un nuovo antagonista, più potente e astuto dei precedenti, che metterà a dura prova i protagonisti.",
            "Gli eventi futuri si concentreranno sulla scoperta di un luogo segreto o di un'antica civiltà, che detiene la chiave per la soluzione.",
            "Il capitolo successivo vedrà i personaggi intraprendere un viaggio epico attraverso terre sconosciute, affrontando pericoli e scoprendo meraviglie.",
            "La storia si addentrerà nei sogni o nella mente di un personaggio, rivelando traumi passati o visioni del futuro.",
            "Il prossimo capitolo esplorerà il lato oscuro di un alleato fidato, mettendo in discussione le lealtà e le motivazioni.",
            "La narrazione si concentrerà su un mistero irrisolto del passato, che torna a tormentare i personaggi nel presente.",
            "Il capitolo successivo vedrà i personaggi affrontare una prova di fede o di coraggio, che determinerà il loro destino.",
            "La storia si concluderà con una rivelazione che cambierà la comprensione del lettore sul mondo e sui personaggi.",
            "Il capitolo seguente introdurrà una nuova fazione o un gruppo di personaggi che complicheranno la trama.",
            "La narrazione si concentrerà su un dilemma etico o morale che i personaggi dovranno affrontare, con conseguenze significative.",
            "Il prossimo capitolo esplorerà un aspetto poco conosciuto dell'ambientazione, rivelando segreti nascosti o pericoli inaspettati.",
            "Gli eventi futuri vedranno i personaggi cercare un oggetto o una persona cruciale per la loro missione, affrontando ostacoli e nemici.",
            "Il capitolo successivo si concentrerà su una battaglia o uno scontro su larga scala, con il destino del mondo in bilico.",
            "La storia rivelerà il vero scopo dell'antagonista e la sua connessione con il passato dei personaggi.",
            "Il prossimo capitolo esplorerà le conseguenze psicologiche delle esperienze vissute dai personaggi, con un focus sulla loro crescita.",
            "La narrazione si concentrerà su un rituale o una cerimonia che svelerà un potere antico o una minaccia latente.",
            "Il capitolo successivo vedrà i personaggi formare un'alleanza inaspettata con un ex nemico per affrontare una minaccia più grande.",
            "La storia si concluderà con un colpo di scena che ribalterà le aspettative del lettore e aprirà nuove possibilità."
        ];

        // Tutti i generi disponibili per la selezione casuale
        const generi = Array.from(genreCards).map(card => card.dataset.genre);


        function fillMainStoryFieldsRandomly() {
            document.getElementById('titoloStoria').value = titoli[Math.floor(Math.random() * titoli.length)];
            
            // Seleziona un numero casuale di generi (da 1 a 3)
            selectedGenres = []; // Reset
            const numGenresToSelect = Math.floor(Math.random() * 3) + 1; // 1, 2, o 3 generi
            const shuffledGenres = [...generi].sort(() => 0.5 - Math.random()); // Mescola i generi
            
            for (let i = 0; i < numGenresToSelect; i++) {
                selectedGenres.push(shuffledGenres[i]);
            }

            // Aggiorna la UI per riflettere i generi selezionati
            genreCards.forEach(card => {
                card.classList.remove('active');
                if (selectedGenres.includes(card.dataset.genre)) {
                    card.classList.add('active');
                }
            });

            document.getElementById('tonoStile').value = toniStili[Math.floor(Math.random() * toniStili.length)];
            document.getElementById('personaggiPrincipali').value = personaggi[Math.floor(Math.random() * personaggi.length)];
            document.getElementById('ambientazioneGenerale').value = ambientazioni[Math.floor(Math.random() * ambientazioni.length)];

            // Randomize protocol parameters
            document.getElementById('lengthP1').value = (Math.floor(Math.random() * (10000 - 1000 + 1)) + 1000).toString();
            document.getElementById('atmP1').value = (Math.floor(Math.random() * (90 - 10 + 1)) + 10).toString();
            document.getElementById('symP1').value = (Math.floor(Math.random() * (5 - 1 + 1)) + 1).toString();
            document.getElementById('turnP1').value = (Math.floor(Math.random() * (1000 - 100 + 1)) + 100).toString();
            
            document.getElementById('transitionP1P2').value = 'Conflitto inatteso';
            document.getElementById('transitionP2P3').value = 'Rivelazione scioccante';
            document.getElementById('transitionP3Next').value = 'Conclusione ambigua';

            showNotification('Campi principali riempiti casualmente!', 'info');
        }

        // Questa funzione ora è usata SOLO da "Compila Tutto Casualmente"
        function fillChapterDetailsWithRandoms() {
            // Rimuovi tutti i capitoli esistenti
            const chaptersContainer = document.getElementById('chaptersContainer');
            chaptersContainer.innerHTML = ''; 
            chapterCount = 0; 

            // Aggiungi 3 capitoli casuali per un totale di 3
            addChapter({
                title: chapterTitles[Math.floor(Math.random() * chapterTitles.length)],
                context: nextContexts[Math.floor(Math.random() * nextContexts.length)],
                start: chapterStarts[Math.floor(Math.random() * chapterStarts.length)],
                startLength: chapterLengths[0],
                startAtm: chapterAtms[0],
                startDialogues: chapterDialogues[0], // NEW
                startChars: chapterChars[Math.floor(Math.random() * chapterChars.length)],
                middle: chapterMiddles[Math.floor(Math.random() * chapterMiddles.length)],
                middleLength: chapterLengths[1],
                middleAtm: chapterAtms[1],
                middleDialogues: chapterDialogues[1], // NEW
                middleChars: chapterChars[Math.floor(Math.random() * chapterChars.length)],
                end: chapterEnds[Math.floor(Math.random() * chapterEnds.length)],
                endLength: chapterLengths[2],
                endAtm: chapterAtms[2],
                endDialogues: chapterDialogues[2], // NEW
                endChars: chapterChars[Math.floor(Math.random() * chapterChars.length)],
                nextContext: nextContexts[Math.floor(Math.random() * nextContexts.length)]
            });

            addChapter({
                title: chapterTitles[Math.floor(Math.random() * chapterTitles.length)],
                context: nextContexts[Math.floor(Math.random() * nextContexts.length)], 
                start: chapterStarts[Math.floor(Math.random() * chapterStarts.length)],
                startLength: chapterLengths[0],
                startAtm: chapterAtms[0],
                startDialogues: chapterDialogues[0], // NEW
                startChars: chapterChars[Math.floor(Math.random() * chapterChars.length)],
                middle: chapterMiddles[Math.floor(Math.random() * chapterMiddles.length)], 
                middleLength: chapterLengths[1],
                middleAtm: chapterAtms[1],
                middleDialogues: chapterDialogues[1], // NEW
                middleChars: chapterChars[Math.floor(Math.random() * chapterChars.length)],
                end: chapterEnds[Math.floor(Math.random() * chapterEnds.length)],
                endLength: chapterLengths[2],
                endAtm: chapterAtms[2],
                endDialogues: chapterDialogues[2], // NEW
                endChars: chapterChars[Math.floor(Math.random() * chapterChars.length)],
                nextContext: nextContexts[Math.floor(Math.random() * nextContexts.length)]
            });

            addChapter({
                title: chapterTitles[Math.floor(Math.random() * chapterTitles.length)],
                context: nextContexts[Math.floor(Math.random() * nextContexts.length)], 
                start: chapterStarts[Math.floor(Math.random() * chapterStarts.length)],
                startLength: chapterLengths[0],
                startAtm: chapterAtms[0],
                startDialogues: chapterDialogues[0], // NEW
                startChars: chapterChars[Math.floor(Math.random() * chapterChars.length)],
                middle: chapterMiddles[Math.floor(Math.random() * chapterMiddles.length)],
                middleLength: chapterLengths[1],
                middleAtm: chapterAtms[1],
                middleDialogues: chapterDialogues[1], // NEW
                middleChars: chapterChars[Math.floor(Math.random() * chapterChars.length)],
                end: chapterEnds[Math.floor(Math.random() * chapterEnds.length)],
                endLength: chapterLengths[2],
                endAtm: chapterAtms[2],
                endDialogues: chapterDialogues[2], // NEW
                endChars: chapterChars[Math.floor(Math.random() * chapterChars.length)],
                nextContext: "" 
            });

            updateChapterNumbers(); 
            showNotification('Capitoli riempiti casualmente!', 'info');
        }

        // Funzione per compilare tutti i campi casualmente (main e chapters)
        function fillRandomFields() {
            fillMainStoryFieldsRandomly();
            fillChapterDetailsWithRandoms(); // Usa la funzione per i capitoli casuali
            showNotification('Campi compilati con idee casuali!', 'success');
        }

        // Funzione per mostrare l'app del generatore e nascondere quella del gioco
        function showGeneratorApp() {
            document.getElementById('generatorApp').style.display = 'block';
            document.getElementById('gameApp').style.display = 'none';
        }

        // Funzione per mostrare l'app del gioco e nascondere quella del generatore
        function showGameApp() {
            document.getElementById('generatorApp').style.display = 'none';
            document.getElementById('gameApp').style.display = 'flex'; // Usa flex per il layout a due colonne
            // Inizializza il gioco quando si passa alla sua vista
            if (!window.gameInitialized) { // Controlla se il gioco è già stato inizializzato
                gameLogic.init();
                window.gameInitialized = true; // Imposta il flag a true
            } else {
                // Se il gioco è già inizializzato, ricarica il capitolo corrente per aggiornare la UI
                gameLogic.loadChapter(gameLogic.gameState.currentChapterId, false);
            }
        }

        // Carica la bozza all'avvio se presente
        document.addEventListener('DOMContentLoaded', () => {
            loadDraftData(); // Carica i dati salvati, inclusi i generi e lo stato musica

            // Assicurati che ci sia sempre almeno un capitolo all'avvio
            if (document.querySelectorAll('.chapter-section').length === 0) {
                addChapter();
            }
            // Se nessun genere è stato caricato/selezionato, assicurati che il primo sia attivo di default
            // Questa logica è ora meno critica dato che selectedGenres è un array e la UI si aggiorna
            // al caricamento della bozza. Se non ci sono generi salvati, l'array sarà vuoto.
            if (selectedGenres.length === 0 && genreCards.length > 0) {
                genreCards[0].classList.add('active');
                selectedGenres.push(genreCards[0].dataset.genre);
            }
            updateChapterNumbers();

            // Inizializza SortableJS per i capitoli
            const chaptersContainer = document.getElementById('chaptersContainer');
            new Sortable(chaptersContainer, {
                animation: 150,
                ghostClass: 'sortable-ghost', // Classe CSS per l'elemento fantasma
                chosenClass: 'sortable-chosen', // Classe CSS per l'elemento scelto
                onEnd: function (evt) {
                    updateChapterNumbers(); // Aggiorna i numeri dopo il riordinamento
                }
            });

            // Event Listeners for buttons
            document.getElementById('addChapterBtn').addEventListener('click', () => addChapter());
            document.getElementById('saveBtn').addEventListener('click', saveDraftData);
            document.getElementById('fillRandomBtn').addEventListener('click', fillRandomFields);
            document.getElementById('resetBtn').addEventListener('click', () => resetForm());
            document.getElementById('generatePromptBtn').addEventListener('click', generatePrompt);
            document.getElementById('copyPromptBtn').addEventListener('click', copyPrompt);
            document.getElementById('downloadPromptBtn').addEventListener('click', downloadPrompt);
            
            // Nuovi Event Listeners per i pulsanti di navigazione tra app
            document.getElementById('goToGameBtn').addEventListener('click', showGameApp);
            document.getElementById('backToGeneratorBtn').addEventListener('click', showGeneratorApp);

            // Event Listeners per l'importazione/esportazione JSON
            document.getElementById('exportJsonBtn').addEventListener('click', exportDraftToJson);
            document.getElementById('importJsonBtn').addEventListener('click', () => {
                document.getElementById('importJsonInput').click(); // Attiva il click sull'input file nascosto
            });
            document.getElementById('importJsonInput').addEventListener('change', importDraftFromJson);
        });


        // --- Inizio del codice del Gioco Narrativo ---

        // Definizione dei capitoli della storia e dei nodi della mappa.
        // Ogni capitolo è un oggetto con le seguenti proprietà:
        // - title (string): Il titolo del capitolo, visualizzato nel pannello di testo e sulla mappa.
        // - text (string): Il corpo del testo del capitolo.
        // - choices (array of objects): Un elenco di scelte disponibili per l'utente.
        //   Ogni scelta ha:
        //   - label (string): Il testo del pulsante di scelta.
        //   - node (number): L'ID del nodo del capitolo a cui porta questa scelta.
        //   - requires (string, optional): L'oggetto richiesto nell'inventario per abilitare questa scelta.
        //   - addsItem (string, optional): L'oggetto aggiunto all'inventario dopo aver selezionare questa scelta.
        //   - effects (array of objects, optional): Effetti da applicare quando questa scelta viene selezionata.
        //     Ogni effetto ha:
        //     - type (string): Tipo di effetto (es. "addItem", "setFlag", "triggerEvent").
        //     - item (string, optional): Nome dell'oggetto da aggiungere/rimuovere per "addItem"/"removeItem".
        //     - flag (string, optional): Nome del flag da impostare per "setFlag".
        //     - value (boolean, optional): Valore del flag per "setFlag".
        //     - eventName (string, optional): Nome dell'evento da scatenare per "triggerEvent".
        // - description (string): Una breve descrizione del nodo, visualizzata quando si passa il mouse sul nodo della mappa.
        // - pos (object): La posizione del nodo sulla mappa.
        //   - top (number): La posizione verticale in percentuale (0-100%).
        //   - left (number): La posizione orizzontale in percentuale (0-100%).
        // - backgroundImg (string, optional): URL dell'immagine di sfondo per questo capitolo, riflette l'Eco del Reame del luogo.
        // - darkText (boolean, optional): Se true, il testo del capitolo sarà chiaro per sfondi scuri, riflettendo l'atmosfera dell'Eco del Reame.
        // - states (object, optional): Stati specifici del capitolo (es. visited).
        const chapters = {
            0: {
                title: "Il Sentiero delle Nuvole",
                text: "L'aria, quel mattino, era un respiro freddo sulla pelle di Lilia, intrisa dell'umido odore di terra e erba. Il sentiero si snodava tra alberi secolari, le cui foglie danzavano leggere al vento, sussurrando storie antiche. Lilia sentiva un richiamo, una curiosità che la spingeva ad andare avanti, verso l'ignoto. Questo è il punto di partenza, un luogo dove l'Eco del Reame è neutra, dove le tracce del passato sono leggere e le possibilità del futuro sono infinite. L'Eco qui è un sussurro, una promessa appena percettibile di ciò che verrà.",
                choices: [
                    { label: "Esplora il Parco", node: 1, effects: [{ type: "setFlag", flag: "visitedPark", value: true }] },
                    { label: "Vai verso la Torre", node: 2 }
                ],
                description: "Punto di partenza nel cuore del sentiero, dove inizia l'avventura di Lilia. L'Eco del Reame è qui neutra, piena di potenziale inespresso.",
                pos: { top: 50, left: 50 }, // Centrale
                backgroundImg: "https://i.ibb.co/hRcSB2wn/il-sentiero-delle-nuvole.png", // Sentiero nebbioso, etereo
                darkText: true, // Testo chiaro per sfondo scuro/nebbioso
                states: { visited: false }
            },
            1: {
                title: "Il Parco delle Promesse Sospese",
                text: "Le nuvole si stendevano nel cielo come lenzuola dimenticate, un bianco lattiginoso che nascondeva un'infinità non detta. Il parco era un'oasi di pace, con fiori dai colori vivaci e il dolce mormorio di un ruscello. Lilia si sentiva avvolta da una sensazione di attesa, come se qualcosa di importante stesse per accadere. Un luogo con un'alta Eco positiva, dove le speranze e i sogni di chi lo ha visitato si sono accumulati, vibrando nell'aria come promesse sospese. Ogni petalo, ogni goccia d'acqua, risuonava con la gioia e la realizzazione passate.",
                choices: [
                    { label: "Avvicinati al Lago", node: 3 },
                    { label: "Ritorna al Sentiero delle Nuvole", node: 0 }
                ],
                description: "Un luogo tranquillo e suggestivo, dove le promesse sembrano fluttuare nell'aria. L'Eco positiva è palpabile qui.",
                pos: { top: 20, left: 20 }, // Top-left
                backgroundImg: "https://i.ibb.co/rGY9JfqY/Il-Parco-delle-Promesse-Sospese.png", // Parco fiorito, luce soffusa
                darkText: false, // Testo scuro per sfondo chiaro
                states: { visited: false }
            },
            2: {
                title: "La Torre dei Ricordi",
                text: "Un uomo, avvolto in un impermeabile consunto, si materializzò accanto a Lilia, la sua figura quasi fusa con l'ombra della torre. La Torre custodisce segreti antichi, storie di tempi andati e di destini intrecciati. Lilia sentiva il peso della storia in quel luogo imponente, un'eco di voci lontane che si manifestava attraverso l'Eco densa e quasi tangibile. Ogni pietra sembrava sussurrare un racconto dimenticato.",
                choices: [
                    { label: "Scala la Torre", node: 4 },
                    { label: "Torna al Sentiero delle Nuvole", node: 0 }
                ],
                description: "Un'antica torre, custode di misteri e memorie nascoste. L'Eco è concentrata nelle sue storie.",
                pos: { top: 80, left: 80 }, // Bottom-right
                backgroundImg: "https://i.ibb.co/7d2BPXp6/La-Torre-dei-Ricordi.png", // Nuova immagine per la torre
                darkText: true, // Testo chiaro per sfondo scuro
                states: { visited: false }
            },
            3: {
                title: "Il Lago Bifronte",
                text: "Le acque del lago riflettevano due cieli, uno limpido e sereno, l'altro tempestoso e carico di nubi. Lilia sentiva il peso delle sue scelte, come le increspature sulla superficie dell'acqua. Era un luogo di riflessione, dove le decisioni sembravano avere un'eco profonda, amplificata dall'Eco conflittuale che permeava ogni goccia. Le sue acque erano uno specchio delle sue incertezze e delle vie divergenti che poteva intraprendere.",
                choices: [
                    { label: "Torna al Parco", node: 1 },
                    { label: "Esplora la Foresta Silente", node: 5 },
                    { label: "Cerca qualcosa nel lago", node: 6, addsItem: "Chiave Antica", effects: [{ type: "addItem", item: "Chiave Antica" }] } // Aggiunge un oggetto
                ],
                description: "Un lago enigmatico che simboleggia i conflitti interiori e le scelte difficili. L'Eco qui è duale e riflessiva.",
                pos: { top: 35, left: 70 }, // Mid-right, slightly down
                backgroundImg: "https://i.ibb.co/zTrjNC3W/Il-Lago-Bifronte.png", // Lago con riflessi contrastanti
                darkText: true, // Testo chiaro per sfondo scuro
                states: { visited: false }
            },
            4: {
                title: "La Vetta della Torre",
                text: "Dall’alto, Lilia vedeva l’intero sentiero delle nuvole, una mappa di luce e ombra che si estendeva all'infinito. Il vento fischiava dolcemente, portando con sé la sensazione di libertà e la consapevolezza di un viaggio ancora lungo. Era un punto di vista privilegiato sul suo cammino, dove l'Eco si manifestava come chiarezza e visione, permettendole di percepire le interconnessioni delle sue scelte e la vasta rete eterea che componeva il Reame. Ogni soffio di vento sembrava sussurrare saggezza antica.",
                choices: [
                    { label: "Scendi dalla Torre", node: 2 },
                    { label: "Osserva il panorama con il Binocolo", node: 7, requires: "Binocolo", effects: [{ type: "setFlag", flag: "observedPanorama", value: true }] } // Richiede un oggetto
                ],
                description: "La cima della torre, offre una visione panoramica e la consapevolezza del proprio percorso. L'Eco qui è chiarezza e intuizione.",
                pos: { top: 90, left: 60 }, // Bottom-center-right
                backgroundImg: "https://i.ibb.co/chzMw4bD/La-Vetta-della-Torre-2.png", // Nuova immagine per la vetta della torre (cielo più aperto)
                darkText: false, // Testo scuro per sfondo più luminoso
                states: { visited: false }
            },
            5: {
                title: "La Foresta Silente",
                text: "Tra gli alberi antichi, il silenzio raccontava storie di tempi perduti, di creature nascoste e di segreti sussurrati dal vento. Ogni passo di Lilia era attutito dal muschio, e l'aria era intrisa di un profumo di terra e mistero. Era un luogo dove la natura regnava sovrana, invitando alla meditazione. Un luogo di Eco profonda e antica, dove il 'silenzio' non era assenza, ma la voce delle storie perdute, un coro etereo di eventi passati che risuonava nel profondo dell'anima.",
                choices: [
                    { label: "Ritorna al Lago Bifronte", node: 3 },
                    { label: "Trova il Binocolo", node: 8, addsItem: "Binocolo", effects: [{ type: "addItem", item: "Binocolo" }] } // Aggiunge un oggetto
                ],
                description: "Una foresta densa e misteriosa, un luogo di meditazione e ascolto dei sussurri del passato. L'Eco è antica e profonda qui.",
                pos: { top: 10, left: 65 }, // Top-right, slightly left
                backgroundImg: "https://i.ibb.co/p9b2RtC/La-Foresta-Silente.png", // Nuova immagine per la foresta
                darkText: true, // Testo chiaro per sfondo scuro
                states: { visited: false }
            },
            6: {
                title: "Il Fondo del Lago",
                text: "Lilia si immerse nelle acque fredde, la visibilità era scarsa ma la sua mano trovò qualcosa di metallico e freddo sul fondo. Era una Chiave Antica, incrostata di alghe, che sembrava promettere l'apertura di qualcosa di importante. L'Eco qui era densa e quasi cristallizzata, manifestandosi in questo artefatto fisico, carico del significato e del potere derivante dalle intenzioni di chi l'aveva persa o nascosta. Un fremito di conoscenza le percorse le dita mentre stringeva l'oggetto.",
                choices: [
                    { label: "Risali al Lago Bifronte", node: 3 }
                ],
                description: "Il fondo del lago, dove si nascondono oggetti preziosi. L'Eco è qui densa e cristallizzata in artefatti.",
                pos: { top: 50, left: 90 }, // Mid-right, far
                backgroundImg: "https://i.ibb.co/5W9SG0xk/Il-Fondo-del-Lago2.png", // Nuova immagine per il fondo del lago
                darkText: true, // Testo chiaro per sfondo scuro
                states: { visited: false }
            },
            7: {
                title: "Orizzonti Lontani",
                text: "Con il binocolo, Lilia poté scrutare l'orizzonte, vedendo dettagli che prima le erano sfuggiti: una piccola capanna nascosta tra le montagne e un sentiero appena visibile che conduceva verso di essa. Il mondo sembrava espandersi davanti ai suoi occhi, e l'Eco si manifestava come possibilità inesplorate, un invito a proseguire il viaggio. Ogni dettaglio rivelato dal binocolo era una nuova traccia eterea, un percorso potenziale che si apriva davanti a lei.",
                choices: [
                    { label: "Scendi dalla Torre", node: 2 },
                    { label: "Vai verso la Capanna del Saggio", node: 9, requires: "Chiave Antica" } // Richiede un oggetto
                ],
                description: "Una vista mozzafiato che rivela nuovi percorsi. L'Eco si espande come nuove possibilità.",
                pos: { top: 90, left: 20 }, // Bottom-left
                backgroundImg: "https://i.ibb.co/spZ01bKz/Orizzonti-Lontani2.png", // Nuova immagine per orizzonti lontani
                darkText: false, // Testo scuro per sfondo potenzialmente luminoso
                states: { visited: false }
            },
            8: {
                title: "Il Nido Nascosto",
                text: "Tra i rami più alti di un albero secolare, Lilia trovò un nido abbandonato. Al suo interno, non c'erano uova, ma un binocolo lucido, quasi nuovo. Sembrava aspettare di essere trovato, promettendo nuove prospettive e un piccolo punto di Eco positiva e scoperta. L'oggetto era intriso di una leggera aura di curiosità e illuminazione, un dono lasciato forse da un altro viaggiatore guidato dall'Eco del Reame.",
                choices: [
                    { label: "Ritorna alla Foresta Silente", node: 5 }
                ],
                description: "Un nascondiglio inaspettato con un oggetto utile. Un piccolo punto di Eco positiva e scoperta.",
                pos: { top: 10, left: 90 }, // Top-right, far
                backgroundImg: "https://i.ibb.co/1f0SyRFS/Il-Nido-Nascosto4.png", // Immagine aggiornata per Il Nido Nascosto
                darkText: false, // Testo scuro per sfondo chiaro
                states: { visited: false }
            },
            9: {
                title: "La Capanna del Saggio",
                text: "La Chiave Antica scattò nella serratura della capanna. All'interno, un vecchio saggio attendeva, circondato da libri e pergamene. Ti sorride e ti invita a sedere, pronto a condividere la sua saggezza. Questo è un finale del tuo viaggio, un luogo dove l'Eco è concentrata e armonizzata, dove tutte le tracce eteree del tuo percorso si uniscono per formare una comprensione più profonda. Il saggio, un maestro dell'Eco del Reame, irradiava una calma che permeava l'intera capanna.",
                choices: [
                    { label: "Inizia un nuovo viaggio", node: 0 } // Finale, si può ricominciare
                ],
                description: "Il luogo del sapere e della conclusione del viaggio. L'Eco qui è concentrata e armonizzata.",
                pos: { top: 10, left: 10 }, // Top-left, far
                backgroundImg: "https://i.ibb.co/DHNkmyvg/La-Capanna-del-Saggio.png", // Immagine aggiornata per la Capanna del Saggio
                darkText: true, // Testo chiaro per sfondo scuro
                states: { visited: false }
            }
        };

        // Riferimenti agli elementi DOM del gioco
        const gameTextPanel = document.querySelector('#gameApp #text-panel');
        const gameMapPanel = document.querySelector('#gameApp #map-panel');
        const gameTextTitle = document.querySelector('#gameApp #chapter-title');
        const gameTextBody = document.querySelector('#gameApp #chapter-text');
        const gameChoicesDiv = document.querySelector('#gameApp #choices');
        const gameMapElement = document.querySelector('#gameApp #map');
        const gameMapCanvas = document.querySelector('#gameApp #map-canvas');
        const gameCtx = gameMapCanvas.getContext('2d');
        const gameNodeDescription = document.querySelector('#gameApp #node-description');
        const gameTimeline = document.querySelector('#gameApp #timeline');
        const gameDiaryNote = document.querySelector('#gameApp #diary-note');
        const gameSaveDiaryBtn = document.querySelector('#gameApp #save-diary');
        const gameCustomAlert = document.querySelector('#gameApp #custom-alert');
        const gameMusicToggleButton = document.querySelector('#gameApp #music-toggle-btn');
        const gameResetZoomBtn = document.querySelector('#gameApp #reset-zoom-btn');
        const gameSoundCloudPlayer = document.querySelector('#gameApp #soundcloud-player');


        const DEBUG_MODE = true; // Imposta a 'true' per abilitare gli strumenti di debug

        /**
         * Mostra un messaggio di allerta personalizzato per il gioco.
         * @param {string} message - Il messaggio da visualizzare.
         * @param {string} type - Il tipo di messaggio ('success', 'error', 'info').
         */
        function showGameAlert(message, type = 'info') {
            gameCustomAlert.textContent = message;
            gameCustomAlert.style.backgroundColor = ''; // Reset background
            switch (type) {
                case 'success':
                    gameCustomAlert.style.backgroundColor = '#4CAF50'; // Verde
                    break;
                case 'error':
                    gameCustomAlert.style.backgroundColor = '#f44336'; // Rosso
                    break;
                case 'info':
                default:
                    gameCustomAlert.style.backgroundColor = '#2196F3'; // Blu
                    break;
            }

            gameCustomAlert.style.opacity = '1';
            setTimeout(() => {
                gameCustomAlert.style.opacity = '0';
            }, 3000);
        }

        // --- Classi per la logica del gioco ---

        class EventSystem {
            constructor() {
                this.listeners = {};
            }

            on(eventName, callback) {
                if (!this.listeners[eventName]) {
                    this.listeners[eventName] = [];
                }
                this.listeners[eventName].push(callback);
            }

            emit(eventName, data) {
                if (this.listeners[eventName]) {
                    this.listeners[eventName].forEach(callback => callback(data));
                }
            }
        }

        class GameState {
            constructor(eventSystem) {
                this.eventSystem = eventSystem;
                this.currentChapterId = 0;
                this.inventory = new Set();
                this.flags = {};
                this.history = []; // Array di ID dei nodi visitati
                this.diary = {}; // Mappa: nodeId -> diaryText
                this.load();
            }

            load() {
                try {
                    const savedState = localStorage.getItem('narrativeGameSave');
                    if (savedState) {
                        const data = JSON.parse(savedState);
                        this.currentChapterId = data.currentChapterId || 0;
                        this.inventory = new Set(data.inventory || []);
                        this.flags = data.flags || {};
                        this.history = data.history || [];
                        this.diary = data.diary || {};
                        if (DEBUG_MODE) console.log("Stato del gioco caricato:", this);
                    }
                } catch (e) {
                    console.error("Errore nel caricamento dello stato del gioco:", e);
                    showGameAlert("Errore nel caricamento dello stato del gioco. Inizio da capo.", 'error');
                    this.reset();
                }
            }

            save() {
                try {
                    const dataToSave = {
                        currentChapterId: this.currentChapterId,
                        inventory: Array.from(this.inventory),
                        flags: this.flags,
                        history: this.history,
                        diary: this.diary
                    };
                    localStorage.setItem('narrativeGameSave', JSON.stringify(dataToSave));
                    if (DEBUG_MODE) console.log("Stato del gioco salvato.");
                } catch (e) {
                    console.error("Errore nel salvataggio dello stato del gioco:", e);
                    showGameAlert("Errore nel salvataggio dello stato del gioco.", 'error');
                }
            }

            reset() {
                this.currentChapterId = 0;
                this.inventory = new Set();
                this.flags = {};
                this.history = [];
                this.diary = {};
                localStorage.removeItem('narrativeGameSave');
                if (DEBUG_MODE) console.log("Stato del gioco resettato.");
            }

            addItem(item) {
                this.inventory.add(item);
                this.eventSystem.emit('inventoryChange', { item: item, type: 'add' });
                showGameAlert(`Hai trovato: ${item}!`, 'success');
                if (DEBUG_MODE) console.log("Inventario aggiornato:", this.inventory);
            }

            removeItem(item) {
                this.inventory.delete(item);
                this.eventSystem.emit('inventoryChange', { item: item, type: 'remove' });
                showGameAlert(`Hai perso: ${item}.`, 'info');
                if (DEBUG_MODE) console.log("Inventario aggiornato:", this.inventory);
            }

            hasItem(item) {
                return this.inventory.has(item);
            }

            setFlag(flag, value) {
                this.flags[flag] = value;
                this.eventSystem.emit('flagChange', { flag: flag, value: value });
                if (DEBUG_MODE) console.log(`Flag '${flag}' impostato a ${value}.`);
            }

            getFlag(flag) {
                return this.flags[flag];
            }
        }

        class EffectSystem {
            constructor(gameState, eventSystem) {
                this.gameState = gameState;
                this.eventSystem = eventSystem;
            }

            applyEffects(effects) {
                if (!effects || !Array.isArray(effects)) return;

                effects.forEach(effect => {
                    switch (effect.type) {
                        case 'addItem':
                            this.gameState.addItem(effect.item);
                            break;
                        case 'removeItem':
                            this.gameState.removeItem(effect.item);
                            break;
                        case 'setFlag':
                            this.gameState.setFlag(effect.flag, effect.value);
                            break;
                        case 'triggerEvent':
                            this.eventSystem.emit(effect.eventName, effect.data || {});
                            break;
                        default:
                            console.warn("Tipo di effetto sconosciuto:", effect.type);
                    }
                });
            }
        }

        class MapManager {
            constructor(mapElement, mapCanvas, ctx, chapters, gameState, eventSystem) {
                this.mapElement = mapElement;
                this.mapCanvas = mapCanvas;
                this.ctx = ctx;
                this.chapters = chapters;
                this.gameState = gameState;
                this.eventSystem = eventSystem;

                this.mapZoom = 1.0;
                this.mapPanX = 0;
                this.mapPanY = 0;
                this.isDragging = false;
                this.startX = 0;
                this.startY = 0;

                this.initMapEvents();
                window.addEventListener('resize', this.resizeCanvas.bind(this));
                this.resizeCanvas(); // Inizializza la dimensione del canvas
            }

            initMapEvents() {
                this.mapElement.addEventListener('mousedown', this.onMouseDown.bind(this));
                this.mapElement.addEventListener('mouseup', this.onMouseUp.bind(this));
                this.mapElement.addEventListener('mousemove', this.onMouseMove.bind(this));
                this.mapElement.addEventListener('mouseleave', this.onMouseUp.bind(this)); // Stop dragging if mouse leaves
                this.mapElement.addEventListener('wheel', this.onMouseWheel.bind(this), { passive: false });

                // Touch events for mobile
                this.mapElement.addEventListener('touchstart', this.onTouchStart.bind(this), { passive: false });
                this.mapElement.addEventListener('touchend', this.onTouchEnd.bind(this));
                this.mapElement.addEventListener('touchmove', this.onTouchMove.bind(this), { passive: false });
            }

            resizeCanvas() {
                const rect = this.mapElement.getBoundingClientRect();
                this.mapCanvas.width = rect.width;
                this.mapCanvas.height = rect.height;
                this.drawMapPaths(); // Ridrawing needed after resize
            }

            onMouseDown(e) {
                this.isDragging = true;
                this.startX = e.clientX - this.mapPanX;
                this.startY = e.clientY - this.mapPanY;
                this.mapElement.style.cursor = 'grabbing';
            }

            onMouseUp() {
                this.isDragging = false;
                this.mapElement.style.cursor = 'grab';
            }

            onMouseMove(e) {
                if (!this.isDragging) return;
                e.preventDefault(); // Prevent text selection during drag
                this.mapPanX = e.clientX - this.startX;
                this.mapPanY = e.clientY - this.startY;
                this.applyMapTransform();
                this.drawMapPaths();
            }

            onTouchStart(e) {
                if (e.touches.length === 1) {
                    this.isDragging = true;
                    this.startX = e.touches[0].clientX - this.mapPanX;
                    this.startY = e.touches[0].clientY - this.mapPanY;
                    this.mapElement.style.cursor = 'grabbing';
                }
            }

            onTouchEnd() {
                this.isDragging = false;
                this.mapElement.style.cursor = 'grab';
            }

            onTouchMove(e) {
                if (!this.isDragging || e.touches.length !== 1) return;
                e.preventDefault();
                this.mapPanX = e.touches[0].clientX - this.startX;
                this.mapPanY = e.touches[0].clientY - this.startY;
                this.applyMapTransform();
                this.drawMapPaths();
            }

            onMouseWheel(e) {
                e.preventDefault(); // Prevent page scrolling
                const scaleAmount = 0.1;
                const mouseX = e.clientX - this.mapElement.getBoundingClientRect().left;
                const mouseY = e.clientY - this.mapElement.getBoundingClientRect().top;

                const oldZoom = this.mapZoom;
                if (e.deltaY < 0) {
                    this.mapZoom += scaleAmount; // Zoom in
                } else {
                    this.mapZoom -= scaleAmount; // Zoom out
                }
                this.mapZoom = Math.max(0.5, Math.min(3.0, this.mapZoom)); // Clamp zoom level

                // Adjust pan to zoom around the mouse cursor
                this.mapPanX = mouseX - ((mouseX - this.mapPanX) / oldZoom) * this.mapZoom;
                this.mapPanY = mouseY - ((mouseY - this.mapPanY) / oldZoom) * this.mapZoom;

                this.applyMapTransform();
                this.drawMapPaths();
            }

            resetZoom() {
                this.mapZoom = 1.0;
                this.mapPanX = 0;
                this.mapPanY = 0;
                this.applyMapTransform();
                this.drawMapPaths();
            }

            createMapNodes() {
                this.mapElement.innerHTML = ''; // Pulisce i nodi esistenti
                for (const id in this.chapters) {
                    const chapter = this.chapters[id];
                    const nodeDiv = document.createElement('div');
                    nodeDiv.classList.add('node');
                    if (parseInt(id) === this.gameState.currentChapterId) {
                        nodeDiv.classList.add('current');
                    }
                    nodeDiv.style.top = `${chapter.pos.top}%`;
                    nodeDiv.style.left = `${chapter.pos.left}%`;
                    nodeDiv.textContent = chapter.title;
                    nodeDiv.dataset.nodeId = id; // Memorizza l'ID del nodo

                    // Add click listener to the node
                    nodeDiv.addEventListener('click', () => {
                        // Only load chapter if it's not the current one
                        if (parseInt(id) !== this.gameState.currentChapterId) {
                            gameLogic.loadChapter(parseInt(id));
                        }
                    });

                    // Aggiungi event listener per mostrare la descrizione al mouseover
                    nodeDiv.addEventListener('mouseover', (e) => {
                        gameNodeDescription.textContent = chapter.description;
                        gameNodeDescription.classList.add('visible');
                    });
                    nodeDiv.addEventListener('mouseout', () => {
                        gameNodeDescription.classList.remove('visible');
                    });

                    this.mapElement.appendChild(nodeDiv);
                }
            }

            drawMapPaths() {
                this.ctx.clearRect(0, 0, this.mapCanvas.width, this.mapCanvas.height); // Pulisce il canvas

                const nodes = {};
                document.querySelectorAll('#gameApp #map .node').forEach(nodeDiv => { // Specificare #gameApp per evitare conflitti
                    const id = parseInt(nodeDiv.dataset.nodeId);
                    // Calcola la posizione effettiva del centro del nodo, considerando zoom e pan
                    const rect = nodeDiv.getBoundingClientRect();
                    const mapRect = this.mapElement.getBoundingClientRect();
                    nodes[id] = {
                        x: (rect.left + rect.right) / 2 - mapRect.left,
                        y: (rect.top + rect.bottom) / 2 - mapRect.top
                    };
                });

                this.ctx.lineWidth = 3;
                this.ctx.lineCap = 'round';

                for (const id in this.chapters) {
                    const chapter = this.chapters[id];
                    if (!nodes[id]) continue; // Assicurati che il nodo esista nel DOM

                    chapter.choices.forEach(choice => {
                        if (nodes[choice.node] && nodes[id]) {
                            const startNode = nodes[id];
                            const endNode = nodes[choice.node];

                            // Disegna la linea
                            this.ctx.beginPath();
                            this.ctx.moveTo(startNode.x, startNode.y);
                            this.ctx.lineTo(endNode.x, endNode.y);

                            // Colore della linea: rosso se il nodo di destinazione è il capitolo corrente, altrimenti grigio
                            if (choice.node === this.gameState.currentChapterId) {
                                this.ctx.strokeStyle = '#f06e6e'; // Rosso per il percorso attivo
                            } else if (this.gameState.history.includes(parseInt(id)) && this.gameState.history.includes(choice.node)) {
                                this.ctx.strokeStyle = '#6b9ddb'; // Blu chiaro per percorsi visitati
                            } else {
                                this.ctx.strokeStyle = '#aaa'; // Grigio per percorsi non visitati
                            }
                            this.ctx.stroke();
                        }
                    });
                }
            }
        }

        class GameLogic {
            constructor(chapters, gameState, eventSystem, mapManager, effectSystem) {
                this.chapters = chapters;
                this.gameState = gameState;
                this.eventSystem = eventSystem;
                this.mapManager = mapManager;
                this.effectSystem = effectSystem;
                this.initListeners();
            }

            initListeners() {
                gameSaveDiaryBtn.addEventListener('click', () => this.saveDiaryNote());
                gameMusicToggleButton.addEventListener('click', () => this.toggleGameMusic());
                gameResetZoomBtn.addEventListener('click', () => this.mapManager.resetZoom());
            }

            init() {
                this.loadChapter(this.gameState.currentChapterId, false); // Carica il capitolo iniziale o salvato
            }

            async loadChapter(nodeId, addToHistory = true) {
                const chapter = this.chapters[nodeId];
                if (!chapter) {
                    console.error(`Capitolo con ID ${nodeId} non trovato.`);
                    return this.fallbackToSafeChapter();
                }

                await this.transitionOut();

                try {
                    this.gameState.currentChapterId = nodeId;
                    if (addToHistory && this.gameState.history[this.gameState.history.length - 1] !== nodeId) {
                        this.gameState.history.push(nodeId);
                    }
                    chapters[nodeId].states.visited = true; // Mark chapter as visited

                    await this.preloadAssets(chapter);
                    this.updateUI(chapter);
                    await this.transitionIn();
                    this.gameState.save();
                    this.eventSystem.emit('onChapterLoad', { id: nodeId, title: chapter.title });

                } catch (error) {
                    console.error("Errore durante il caricamento del capitolo:", error);
                    showGameAlert("Errore nel caricamento del capitolo.", 'error'); // Corrected call
                    this.recoverFromError();
                }
            }

            fallbackToSafeChapter() {
                console.error("Tentativo di fallback al capitolo iniziale (0).");
                if (this.gameState.currentChapterId !== 0) {
                    this.loadChapter(0, false);
                } else {
                    showGameAlert("Impossibile caricare il capitolo iniziale. Ricarica la pagina.", 'error');
                }
            }

            recoverFromError() {
                // Implementa una logica di recupero più robusta se necessario
                this.gameState.reset();
                this.loadChapter(0, false);
            }

            async transitionOut() {
                return new Promise(resolve => {
                    gameTextPanel.classList.add('fade-out');
                    gameMapPanel.classList.add('fade-out');
                    setTimeout(resolve, 400);
                });
            }

            async transitionIn() {
                return new Promise(resolve => {
                    gameTextPanel.classList.remove('fade-out');
                    gameMapPanel.classList.remove('fade-out');
                    setTimeout(resolve, 400);
                });
            }

            async preloadAssets(chapter) {
                const promises = [];
                if (chapter.backgroundImg) {
                    promises.push(new Promise((resolve) => {
                        const img = new Image();
                        img.src = chapter.backgroundImg;
                        img.onload = resolve;
                        img.onerror = () => {
                            console.warn("Impossibile caricare l'immagine di sfondo:", chapter.backgroundImg);
                            resolve();
                        };
                    }));
                }
                await Promise.all(promises);
            }

            updateUI(chapter) {
                gameTextTitle.textContent = chapter.title;
                gameTextBody.textContent = chapter.text;

                gameTextPanel.style.backgroundImage = chapter.backgroundImg ? `url(${chapter.backgroundImg})` : 'none';
                
                // Apply darkText override class
                if (chapter.darkText) {
                    gameTextPanel.classList.add('dark-text-override');
                } else {
                    gameTextPanel.classList.remove('dark-text-override');
                }
                
                this.updateChoices();
                this.mapManager.createMapNodes();
                this.mapManager.drawMapPaths();
                gameNodeDescription.textContent = chapter.description;
                gameNodeDescription.classList.add('visible');
                this.updateTimeline();
                gameDiaryNote.value = this.gameState.diary[this.gameState.currentChapterId] || "";
            }

            updateChoices() {
                gameChoicesDiv.innerHTML = '';
                const chapter = this.chapters[this.gameState.currentChapterId];

                chapter.choices.forEach(choice => {
                    const choiceBtn = document.createElement('button');
                    choiceBtn.classList.add('choice-btn');
                    choiceBtn.textContent = choice.label;
                    choiceBtn.dataset.node = choice.node;

                    let isDisabled = false;
                    if (choice.requires && !this.gameState.hasItem(choice.requires)) {
                        isDisabled = true;
                        choiceBtn.textContent += ` (Richiede: ${choice.requires})`;
                    }
                    // Aggiungi logica per i flag se necessario
                    if (choice.requiresFlag && !this.gameState.getFlag(choice.requiresFlag)) {
                        isDisabled = true;
                        choiceBtn.textContent += ` (Richiede flag: ${choice.requiresFlag})`;
                    }

                    choiceBtn.disabled = isDisabled;

                    choiceBtn.addEventListener('click', () => {
                        if (DEBUG_MODE) console.log("Scelta selezionata:", choice.label, "porta a nodo:", choice.node);
                        this.effectSystem.applyEffects(choice.effects); // Applica gli effetti prima di cambiare capitolo
                        if (choice.addsItem) {
                            this.gameState.addItem(choice.addsItem);
                        }
                        this.loadChapter(parseInt(choice.node));
                    });
                    gameChoicesDiv.appendChild(choiceBtn);
                });
            }

            updateTimeline() {
                gameTimeline.innerHTML = '';
                this.gameState.history.forEach((nodeId, index) => {
                    const chapter = this.chapters[nodeId];
                    if (chapter) {
                        const timelineNode = document.createElement('span');
                        timelineNode.classList.add('timeline-node');
                        timelineNode.textContent = chapter.title;
                        timelineNode.dataset.nodeId = nodeId;
                        if (nodeId === this.gameState.currentChapterId) {
                            timelineNode.classList.add('current');
                        }
                        timelineNode.addEventListener('click', () => {
                            if (DEBUG_MODE) console.log("Cliccato su nodo timeline:", nodeId);
                            this.loadChapter(nodeId, false); // Non aggiungere alla cronologia se si torna indietro
                        });
                        gameTimeline.appendChild(timelineNode);
                    }
                });
                // Scroll to the end of the timeline to show the current node
                gameTimeline.scrollLeft = gameTimeline.scrollWidth;
            }

            saveDiaryNote() {
                this.gameState.diary[this.gameState.currentChapterId] = gameDiaryNote.value.trim();
                this.gameState.save();
                showGameAlert("Nota del diario salvata!", 'success');
            }

            toggleGameMusic() {
                if (gameSoundCloudPlayer.style.display === 'none') {
                    gameSoundCloudPlayer.style.display = 'block';
                    gameSoundCloudPlayer.src = audioSrc; // Assicurati che l'autoplay sia true nell'src
                    gameMusicToggleButton.textContent = 'Ferma Musica';
                    showGameAlert('Musica di sottofondo avviata!', 'info');
                } else {
                    gameSoundCloudPlayer.style.display = 'none';
                    gameSoundCloudPlayer.src = ''; // Ferma la riproduzione
                    gameMusicToggleButton.textContent = 'Avvia Musica';
                    showGameAlert('Musica di sottofondo fermata!', 'info');
                }
            }

            // Funzione per generare un segmento di storia usando Gemini API
            async generateStorySegment(prompt) {
                showGameAlert("Generazione di un segmento di storia...", "info");
                try {
                    let chatHistory = [];
                    chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                    const payload = { contents: chatHistory };
                    const apiKey = ""; // Lascia vuoto, sarà fornita dall'ambiente Canvas
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const result = await response.json();
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const text = result.candidates[0].content.parts[0].text;
                        showGameAlert("Segmento generato!", "success");
                        return text;
                    } else {
                        showGameAlert("Nessuna risposta valida dall'API.", "error");
                        console.error("Struttura della risposta API inattesa:", result);
                        return "Errore: Impossibile generare la storia. Riprova.";
                    }
                } catch (error) {
                    showGameAlert("Errore nella chiamata API.", "error");
                    console.error("Errore API Gemini:", error);
                    return "Errore: Impossibile connettersi al servizio di generazione storia.";
                }
            }
        }

        // Inizializzazione delle classi del gioco
        const eventSystem = new EventSystem();
        const gameState = new GameState(eventSystem);
        const mapManager = new MapManager(gameMapElement, gameMapCanvas, gameCtx, chapters, gameState, eventSystem);
        const effectSystem = new EffectSystem(gameState, eventSystem);
        const plugins = new EventSystem(); // Usiamo EventSystem anche per i plugin
        const gameLogic = new GameLogic(chapters, gameState, eventSystem, mapManager, effectSystem);

        // Aggiungi un plugin di esempio (potrebbe essere in un file separato)
        plugins.on('onChapterLoad', (data) => {
            if (DEBUG_MODE) console.log(`Plugin: Capitolo ${data.id} "${data.title}" caricato.`);
            // Esempio: potresti triggerare un evento specifico in base al capitolo
            if (data.id === 9) { // Se è il capitolo finale
                showGameAlert("Hai completato il viaggio! Inizia un nuovo percorso.", "success");
            }
        });

        // Assicurati che il gioco sia inizializzato solo una volta
        window.gameInitialized = false;
    </script>
</body>
</html>
